# 通用卡密与授权系统 - 后端开发任务清单

> **项目技术栈**：FastAPI + SQLAlchemy + Alembic + MySQL + Pydantic + JWT
> 
> **任务组织原则**：按照数据层 → 服务层 → 接口层的顺序逐步实现

---

## 📋 任务总览

- **阶段一**：数据库设计与基础设施（任务 1-3）✅ **已完成**
- **阶段二**：用户认证系统（任务 4-6）✅ **已完成**
- **阶段三**：卡密管理系统（任务 7-10）✅ **已完成**
- **阶段四**：权限校验系统（任务 11-13）⏳ 待开发
- **阶段五**：管理后台功能（任务 14-16）⏳ 待开发
- **阶段六**：增强与优化（任务 17-20）⏳ 待开发

---

## 阶段一：数据库设计与基础设施

### ✅ 任务 1：创建数据库模型（Models）

**目标**：在 `app/models/` 目录下创建所有数据表的 SQLAlchemy 模型

**文件清单**：
- `app/models/app.py` - 应用表模型
- `app/models/user.py` - 用户表模型
- `app/models/card.py` - 卡密表模型
- `app/models/user_card.py` - 用户-卡密绑定表模型
- `app/models/card_device.py` - 卡密-设备绑定表模型
- `app/models/user_token.py` - 用户Token表模型（登录会话管理）

**核心字段要求**：

#### 1.1 应用表（app）
```python
- id: 主键
- app_key: 应用唯一标识（唯一索引）
- app_name: 应用名称
- status: 状态（normal/disabled）
- created_at: 创建时间
- updated_at: 更新时间
```

#### 1.2 用户表（user）
```python
- id: 主键
- username: 用户名（唯一索引）
- password_hash: 密码哈希
- status: 状态（normal/banned）
- created_at: 创建时间
- last_login_at: 最后登录时间
- updated_at: 更新时间
```

#### 1.3 卡密表（card）
```python
- id: 主键
- app_id: 所属应用（外键）
- card_key: 卡密字符串（唯一索引）
- status: 状态（unused/used/disabled）
- expire_time: 过期时间
- max_device_count: 最大可绑定设备数
- permissions: JSON 权限配置
- remark: 备注（套餐名称等）
- created_at: 创建时间
- updated_at: 更新时间
```

#### 1.4 用户-卡密绑定表（user_card）
```python
- id: 主键
- user_id: 用户ID（外键）
- card_id: 卡密ID（外键）
- bind_time: 绑定时间
- status: 状态（active/unbind）
- created_at: 创建时间
- updated_at: 更新时间
- 唯一索引：(user_id, card_id)
```

#### 1.5 卡密-设备绑定表（card_device）
```python
- id: 主键
- card_id: 卡密ID（外键）
- device_id: 设备唯一标识
- device_name: 设备名称（可选）
- bind_time: 绑定时间
- last_active_at: 最后活跃时间
- status: 状态（active/disabled）
- created_at: 创建时间
- updated_at: 更新时间
- 唯一索引：(card_id, device_id)
```

#### 1.6 用户Token表（user_token）
```python
- id: 主键
- user_id: 用户ID（外键）
- app_id: 应用ID（外键）
- token: JWT Token（唯一索引）
- device_id: 设备标识
- expire_time: 过期时间
- created_at: 创建时间
```

**技术要点**：
- 使用 SQLAlchemy 的声明式基类
- 添加适当的索引（唯一索引、外键索引）
- 使用 `DateTime` 时区感知字段
- JSON 字段使用 SQLAlchemy 的 `JSON` 类型
- 添加关系映射（relationship）方便查询

---

### ✅ 任务 2：创建数据库迁移脚本

**目标**：使用 Alembic 生成并应用数据库迁移

**操作步骤**：
```bash
# 1. 生成迁移脚本
python -m app.scripts.set_env dev migrate revision --autogenerate -m "创建授权系统核心表"

# 2. 检查生成的迁移文件
# 查看 alembic/versions/ 目录下的新文件

# 3. 应用迁移
python -m app.scripts.set_env dev upgrade

# 4. 验证表结构
# 连接数据库查看表是否正确创建
```

**验证清单**：
- ✅ 所有表创建成功
- ✅ 外键约束正确
- ✅ 唯一索引创建成功
- ✅ JSON 字段类型正确

---

### ✅ 任务 3：创建 Pydantic Schemas

**目标**：在 `app/schemas/` 目录下创建请求/响应数据验证模型

**文件清单**：
- `app/schemas/auth.py` - 认证相关（登录、注册）
- `app/schemas/card.py` - 卡密相关
- `app/schemas/permission.py` - 权限校验相关
- `app/schemas/user.py` - 用户信息相关
- `app/schemas/app.py` - 应用信息相关
- `app/schemas/admin.py` - 管理后台相关

**核心 Schema 示例**：

#### 3.1 认证 Schemas（auth.py）
```python
class UserRegisterRequest(BaseModel):
    username: str
    password: str

class UserLoginRequest(BaseModel):
    username: str
    password: str
    app_key: str
    device_id: str

class LoginResponse(BaseModel):
    token: str
    user_status: str
    has_card: bool
```

#### 3.2 卡密 Schemas（card.py）
```python
class CardBindRequest(BaseModel):
    card_key: str
    device_id: str
    device_name: Optional[str] = None

class CardInfo(BaseModel):
    card_key: str
    expire_time: datetime
    permissions: List[str] | dict
    bind_devices: int
    max_device_count: int

class MyCardResponse(BaseModel):
    has_card: bool
    cards: List[CardInfo]
```

#### 3.3 权限校验 Schemas（permission.py）
```python
class PermissionCheckRequest(BaseModel):
    permission: str
    device_id: str

class PermissionCheckResponse(BaseModel):
    allowed: bool
    message: str
    expire_time: Optional[datetime] = None
```

---

## 阶段二：用户认证系统

### ✅ 任务 4：实现密码加密与 JWT 工具

**目标**：创建安全工具模块

**文件路径**：`app/core/security.py`

**功能清单**：
- 密码哈希生成（使用 `bcrypt` 或 `passlib`）
- 密码验证
- JWT Token 生成（包含 user_id, app_id, device_id）
- JWT Token 解析与验证
- Token 过期时间配置

**依赖安装**：
```bash
pip install python-jose[cryptography] passlib[bcrypt]
```

**示例函数**：
```python
def hash_password(password: str) -> str
def verify_password(plain_password: str, hashed_password: str) -> bool
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str
def decode_access_token(token: str) -> dict
```

---

### ✅ 任务 5：实现用户认证服务层

**目标**：创建用户认证业务逻辑

**文件路径**：`app/services/auth_service.py`

**核心功能**：

#### 5.1 用户注册
- 检查用户名是否已存在
- 密码哈希处理
- 创建用户记录
- 返回用户信息

#### 5.2 用户登录
- 验证用户名和密码
- 检查用户状态（是否被封禁）
- 生成 JWT Token
- 记录登录时间和设备信息
- 创建 Token 记录到 `user_token` 表
- 检查用户是否已绑定卡密
- 返回 Token 和用户状态

#### 5.3 Token 验证
- 解析 JWT Token
- 验证 Token 是否在数据库中存在
- 验证 Token 是否过期
- 验证设备 ID 是否匹配
- 返回用户信息

---

### ✅ 任务 6：实现认证 API 接口

**目标**：创建用户认证相关的 HTTP 接口

**文件路径**：`app/api/endpoints/auth.py`

**接口清单**：

#### 6.1 用户注册
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}

Response:
{
  "id": 1,
  "username": "testuser",
  "status": "normal"
}
```

#### 6.2 用户登录
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123",
  "app_key": "wx_crawler_app",
  "device_id": "abc123def456"
}

Response:
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user_status": "normal",
  "has_card": false
}
```

#### 6.3 Token 验证（内部使用）
```http
GET /api/v1/auth/verify
Authorization: Bearer {token}

Response:
{
  "user_id": 1,
  "username": "testuser",
  "status": "normal"
}
```

**技术要点**：
- 使用 FastAPI 的依赖注入
- 创建 `get_current_user` 依赖函数
- 统一异常处理

---

## 阶段三：卡密管理系统

### ✅ 任务 7：实现卡密生成工具

**目标**：创建卡密生成算法

**文件路径**：`app/utils/card_generator.py`

**功能要求**：
- 生成格式：`XXXX-XXXX-XXXX-XXXX`（16位，4段）
- 字符集：`A-Z + 2-9`（去除 0/O/1/I 避免混淆）
- 保证唯一性（生成时检查数据库）
- 支持批量生成

**示例函数**：
```python
def generate_card_key() -> str
def generate_batch_cards(count: int) -> List[str]
def validate_card_key_format(card_key: str) -> bool
```

---

### ✅ 任务 8：实现卡密服务层

**目标**：创建卡密管理业务逻辑

**文件路径**：`app/services/card_service.py`

**核心功能**：

#### 8.1 查询用户的卡密
- 根据 user_id 查询已绑定的卡密
- 联表查询卡密详情、权限、设备绑定数
- 返回卡密列表

#### 8.2 绑定卡密
- 验证卡密是否存在
- 验证卡密是否属于当前应用
- 验证卡密状态（是否禁用、是否过期）
- 验证设备数量限制
- 创建 user_card 绑定关系
- 创建 card_device 设备绑定
- 更新卡密状态为 `used`
- 返回绑定结果

#### 8.3 解绑卡密
- 验证用户是否拥有该卡密
- 删除设备绑定
- 更新 user_card 状态为 `unbind`
- 如果所有设备解绑，卡密状态改回 `unused`

#### 8.4 查询卡密详情
- 根据 card_id 查询卡密信息
- 包含绑定的用户和设备列表

---

### ✅ 任务 9：实现卡密 API 接口

**目标**：创建卡密管理相关的 HTTP 接口

**文件路径**：`app/api/endpoints/card.py`

**接口清单**：

#### 9.1 查询我的卡密
```http
GET /api/v1/card/my
Authorization: Bearer {token}

Response:
{
  "has_card": true,
  "cards": [
    {
      "card_key": "ABCD-EFGH-IJKL-MNOP",
      "expire_time": "2026-01-01T00:00:00",
      "permissions": ["wechat", "ximalaya"],
      "bind_devices": 1,
      "max_device_count": 2
    }
  ]
}
```

#### 9.2 绑定卡密
```http
POST /api/v1/card/bind
Authorization: Bearer {token}
Content-Type: application/json

{
  "card_key": "ABCD-EFGH-IJKL-MNOP",
  "device_id": "abc123def456",
  "device_name": "MyPC"
}

Response:
{
  "success": true,
  "message": "卡密绑定成功",
  "card_info": {
    "expire_time": "2026-01-01T00:00:00",
    "permissions": ["wechat", "ximalaya"]
  }
}
```

#### 9.3 解绑设备
```http
POST /api/v1/card/unbind-device
Authorization: Bearer {token}
Content-Type: application/json

{
  "card_id": 1,
  "device_id": "abc123def456"
}

Response:
{
  "success": true,
  "message": "设备解绑成功"
}
```

---

### ✅ 任务 10：实现应用管理功能

**目标**：管理多应用支持

**文件路径**：
- `app/services/app_service.py` - 应用服务层
- `app/api/endpoints/app.py` - 应用接口

**核心功能**：
- 创建应用（生成 app_key）
- 查询应用列表
- 启用/禁用应用
- 根据 app_key 验证应用有效性

**接口示例**：
```http
GET /api/v1/app/list
POST /api/v1/app/create
PUT /api/v1/app/{app_id}/status
```

---

## 阶段四：权限校验系统

### ✅ 任务 11：实现权限校验服务层

**目标**：创建权限验证核心逻辑

**文件路径**：`app/services/permission_service.py`

**核心功能**：

#### 11.1 权限校验
- 验证用户是否登录
- 验证用户状态（是否被封禁）
- 验证用户是否绑定卡密
- 验证卡密状态（是否禁用、是否过期）
- 验证设备是否绑定
- 验证设备状态（是否被禁用）
- 验证权限配置（permission 是否在卡密的 permissions 中）
- 更新设备最后活跃时间
- 返回校验结果

**校验逻辑流程图**：
```
1. 解析 Token → 获取 user_id, device_id
2. 查询用户状态 → 是否 banned
3. 查询用户绑定的卡密 → 是否有有效卡密
4. 检查卡密过期时间 → 是否过期
5. 检查设备绑定 → 设备是否在绑定列表
6. 检查设备状态 → 设备是否被禁用
7. 检查权限配置 → permission 是否在 permissions 中
8. 更新 last_active_at
9. 返回 allowed=true/false
```

---

### ✅ 任务 12：实现权限校验 API 接口

**目标**：创建权限校验 HTTP 接口

**文件路径**：`app/api/endpoints/permission.py`

**接口清单**：

#### 12.1 权限校验
```http
POST /api/v1/permission/check
Authorization: Bearer {token}
Content-Type: application/json

{
  "permission": "wechat",
  "device_id": "abc123def456"
}

Response:
{
  "allowed": true,
  "message": "权限验证通过",
  "expire_time": "2026-01-01T00:00:00"
}

或：
{
  "allowed": false,
  "message": "卡密已过期",
  "expire_time": null
}
```

---

### ✅ 任务 13：创建权限校验装饰器/依赖

**目标**：方便其他接口快速集成权限校验

**文件路径**：`app/decorators/permission_decorator.py`

**使用示例**：
```python
from app.decorators.permission_decorator import require_permission

@router.get("/wx/search")
@require_permission("wechat")
async def search_wechat(
    query: str,
    current_user: dict = Depends(get_current_user)
):
    # 业务逻辑
    pass
```

**技术要点**：
- 使用 FastAPI 的依赖注入
- 自动获取 Token 和 device_id
- 校验失败抛出 HTTPException

---

## 阶段五：管理后台功能

### ✅ 任务 14：实现卡密生成接口（管理员）

**目标**：为管理员提供批量生成卡密的功能

**文件路径**：
- `app/services/admin_service.py` - 管理服务层
- `app/api/endpoints/admin.py` - 管理接口

**接口定义**：
```http
POST /api/v1/admin/card/generate
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "app_id": 1,
  "count": 100,
  "expire_time": "2026-01-01T00:00:00",
  "max_device_count": 2,
  "permissions": ["wechat", "ximalaya"],
  "remark": "高级套餐"
}

Response:
{
  "success": true,
  "cards": [
    "ABCD-EFGH-IJKL-MNOP",
    "QRST-UVWX-YZ23-4567"
  ]
}
```

**功能要点**：
- 批量生成卡密
- 插入数据库
- 返回卡密列表（可导出）
- 需要管理员权限验证

---

### ✅ 任务 15：实现管理员权限控制

**目标**：创建管理员角色和权限验证

**扩展 user 表**：
```python
# 在 user 模型中添加字段
- role: 用户角色（user/admin）
```

**创建管理员依赖**：
```python
# app/utils/dependencies.py
async def get_current_admin(
    current_user: dict = Depends(get_current_user)
):
    if current_user.get("role") != "admin":
        raise HTTPException(status_code=403, detail="需要管理员权限")
    return current_user
```

**应用到管理接口**：
```python
@router.post("/admin/card/generate")
async def generate_cards(
    request: CardGenerateRequest,
    admin: dict = Depends(get_current_admin)
):
    # 管理逻辑
    pass
```

---

### ✅ 任务 16：实现管理后台查询接口

**目标**：提供后台管理所需的查询功能

**文件路径**：`app/api/endpoints/admin.py`

**接口清单**：

#### 16.1 查询所有用户
```http
GET /api/v1/admin/users?page=1&size=20
Authorization: Bearer {admin_token}
```

#### 16.2 封禁/解封用户
```http
PUT /api/v1/admin/user/{user_id}/status
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "status": "banned"  // 或 "normal"
}
```

#### 16.3 查询所有卡密
```http
GET /api/v1/admin/cards?status=unused&page=1&size=20
Authorization: Bearer {admin_token}
```

#### 16.4 修改卡密状态
```http
PUT /api/v1/admin/card/{card_id}/status
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "status": "disabled"
}
```

#### 16.5 修改卡密权限（实时生效）
```http
PUT /api/v1/admin/card/{card_id}/permissions
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "permissions": ["wechat"]
}
```

#### 16.6 查询设备绑定列表
```http
GET /api/v1/admin/devices?card_id=1
Authorization: Bearer {admin_token}
```

#### 16.7 禁用/启用设备
```http
PUT /api/v1/admin/device/{device_id}/status
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "status": "disabled"
}
```

---

## 阶段六：增强与优化

### ✅ 任务 17：实现缓存优化

**目标**：使用 cachetools 优化权限校验性能

**文件路径**：`app/decorators/cache_decorator.py`（已存在，扩展功能）

**缓存策略**：

#### 17.1 用户信息缓存
- 缓存 Token → User 信息映射
- 过期时间：15 分钟
- 用户状态变更时清除缓存

#### 17.2 权限校验缓存
- 缓存 (user_id, permission, device_id) → 校验结果
- 过期时间：5 分钟
- 卡密权限变更时清除缓存

#### 17.3 卡密信息缓存
- 缓存 card_id → 卡密详情
- 过期时间：10 分钟
- 卡密修改时清除缓存

**使用示例**：
```python
from app.decorators.cache_decorator import cache_with_ttl

@cache_with_ttl(ttl=300)
async def check_permission(user_id: int, permission: str, device_id: str):
    # 校验逻辑
    pass
```

---

### ✅ 任务 18：添加日志记录

**目标**：使用 loguru 记录关键操作日志

**文件路径**：在各 service 层添加日志

**日志记录点**：
- 用户注册/登录
- 卡密绑定/解绑
- 权限校验（通过/拒绝）
- 管理员操作（生成卡密、封禁用户等）
- 异常错误

**示例**：
```python
from app.core.logging import logger

logger.info(f"用户 {user_id} 绑定卡密 {card_key}")
logger.warning(f"权限校验失败：用户 {user_id}，权限 {permission}")
logger.error(f"卡密生成失败：{e}")
```

---

### ✅ 任务 19：实现统一异常处理

**目标**：创建业务异常类和统一处理

**文件路径**：`app/core/exceptions.py`

**自定义异常**：
```python
class AuthException(Exception):
    """认证异常"""
    pass

class CardException(Exception):
    """卡密异常"""
    pass

class PermissionException(Exception):
    """权限异常"""
    pass
```

**异常处理器**：
```python
# app/middleware/exception_handlers.py
@app.exception_handler(CardException)
async def card_exception_handler(request: Request, exc: CardException):
    return JSONResponse(
        status_code=400,
        content={"message": str(exc)}
    )
```

---

### ✅ 任务 20：编写接口文档和测试

**目标**：完善 API 文档并进行测试

#### 20.1 API 文档
- FastAPI 自动生成的 Swagger 文档（`/docs`）
- 添加接口描述、参数说明、响应示例
- 使用 `response_model` 规范响应格式

#### 20.2 单元测试
- 使用 `pytest` 编写测试用例
- 测试用户注册/登录
- 测试卡密绑定逻辑
- 测试权限校验逻辑

**测试文件**：
```
tests/
├── test_auth.py          # 认证测试
├── test_card.py          # 卡密测试
├── test_permission.py    # 权限测试
└── test_admin.py         # 管理功能测试
```

#### 20.3 接口测试
- 使用 Postman 或 httpx 测试所有接口
- 验证正常流程和异常流程
- 测试并发场景（多设备绑定等）

---

## 📝 任务执行建议

### 开发顺序
1. **优先完成阶段一**：数据库和数据模型是基础
2. **按阶段顺序开发**：每个阶段依赖前一个阶段
3. **边开发边测试**：每完成一个任务，立即测试验证

### 测试策略
- 完成任务 6 后：测试用户注册登录流程
- 完成任务 9 后：测试卡密绑定流程
- 完成任务 12 后：测试完整的权限校验流程
- 完成任务 16 后：测试管理后台功能

### 代码规范
- 使用类型提示（Type Hints）
- 统一错误处理
- 添加必要的注释
- 遵循 FastAPI 最佳实践

---

## 🎯 最终交付清单

### 数据库
- ✅ 6 张核心表创建完成
- ✅ 索引和外键配置正确
- ✅ 支持多环境数据库配置

### API 接口
- ✅ 用户注册/登录接口
- ✅ 卡密查询/绑定接口
- ✅ 权限校验接口
- ✅ 管理后台接口（生成卡密、用户管理、卡密管理）

### 核心功能
- ✅ JWT 认证机制
- ✅ 密码加密存储
- ✅ 卡密生成算法
- ✅ 多设备绑定控制
- ✅ 实时权限校验
- ✅ 用户/卡密封禁功能
- ✅ 卡密权限实时修改

### 性能优化
- ✅ 缓存机制（权限校验缓存）
- ✅ 数据库索引优化
- ✅ 日志记录完善

### 文档与测试
- ✅ Swagger API 文档
- ✅ 接口测试用例
- ✅ 业务流程测试

---

## 🚀 后续扩展方向

根据设计文档中的版本演进建议，后续可扩展：

1. **邮箱验证码**：注册时验证邮箱
2. **付费/续费系统**：集成支付接口
3. **卡密叠加**：一个用户绑定多张卡密，权限合并
4. **订阅制授权**：按月/年订阅模式
5. **管理后台 UI**：Vue3 + Element Plus 前端
6. **数据统计**：用户活跃度、卡密使用情况分析
7. **WebSocket 通知**：实时推送权限变更、强制下线等

---

> **说明**：
> - 每个任务都是独立可测试的
> - 建议按顺序完成，后面的任务依赖前面的基础
> - 所有接口都需要考虑异常情况和边界条件
> - 代码需符合项目现有的规范和结构
