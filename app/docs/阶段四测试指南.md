# 阶段四：权限校验系统 - 测试指南

## 📋 测试前准备

### 1. 确保服务正常运行
```bash
python run_app.py
```

### 2. 确保已有测试数据

如果还没有测试卡密，执行：
```bash
mysql -u root -p login_km_system_dev < app/scripts/insert_test_cards.sql
```

### 3. 准备测试账户

使用默认的测试账户：
- **用户名**: testuser
- **密码**: test123456
- **应用**: default_app

---

## 🧪 测试流程

### 场景 1：完整的权限校验流程

#### 步骤 1：用户登录
```bash
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-001"
  }'
```

**保存返回的 token**

---

#### 步骤 2：绑定测试卡密

```bash
curl -X POST "http://localhost:8003/api/v1/card/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_key": "A3KD-Q7LM-P2E8-W9RZ",
    "device_id": "device-001",
    "device_name": "测试设备"
  }'
```

**预期结果**：绑定成功

**注意**：这个卡密包含 `["wechat", "ximalaya"]` 权限

---

#### 步骤 3：查询我的权限

```bash
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期结果**：
```json
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

---

#### 步骤 4：校验拥有的权限（应该通过）

```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permission": "wechat", // 权限字段
    "device_id": ['123'] // 设备id
  }'
```

**预期结果**：
```json
{
  "allowed": true,
  "message": "权限验证通过",
  "expire_time": "2026-12-31T23:59:59"
}
```

---

#### 步骤 5：校验没有的权限（应该失败）

```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permission": "douyin"
  }'
```

**预期结果**：
```json
{
  "allowed": false,
  "message": "没有有效的卡密或权限配置不匹配",
  "expire_time": null
}
```

---

#### 步骤 6：批量校验权限

```bash
curl -X POST "http://localhost:8003/api/v1/permission/batch-check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
  }'
```

**预期结果**：
```json
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false,
    "kuaishou": false
  }
}
```

---

### 场景 2：测试未登录用户

```bash
# 不提供 token
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -d '{
    "permission": "wechat"
  }'
```

**预期结果**：401 Unauthorized

---

### 场景 3：测试未绑定卡密的用户

#### 步骤 1：创建新用户
```bash
curl -X POST "http://localhost:8003/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123"
  }'
```

#### 步骤 2：登录新用户
```bash
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123",
    "app_key": "default_app",
    "device_id": "device-002"
  }'
```

#### 步骤 3：校验权限（应该失败）
```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer NEW_USER_TOKEN" \
  -d '{
    "permission": "wechat"
  }'
```

**预期结果**：
```json
{
  "allowed": false,
  "message": "未绑定卡密",
  "expire_time": null
}
```

---

### 场景 4：测试过期的卡密

#### 步骤 1：绑定已过期的卡密
```bash
curl -X POST "http://localhost:8003/api/v1/card/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_key": "E2YX-WV9Z-NM3K-PQ7R",
    "device_id": "device-001"
  }'
```

**预期结果**：绑定失败，提示 "卡密已过期"

---

### 场景 5：测试设备未绑定

#### 步骤 1：使用不同的设备登录
```bash
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-999"
  }'
```

#### 步骤 2：校验权限（应该失败）
```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer DEVICE_999_TOKEN" \
  -d '{
    "permission": "wechat"
  }'
```

**预期结果**：
```json
{
  "allowed": false,
  "message": "该设备未绑定有效卡密",
  "expire_time": null
}
```

---

## 🎯 使用 Swagger UI 测试（推荐）

### 1. 打开 Swagger UI
访问: http://localhost:8003/docs

### 2. 测试流程

**2.1 登录获取 Token**
1. 找到 `POST /api/v1/auth/login` 接口
2. 使用测试账户登录
3. 复制返回的 token

**2.2 设置认证**
1. 点击页面右上角的 🔒 "Authorize" 按钮
2. 输入 token
3. 点击 "Authorize"

**2.3 绑定卡密**
1. 找到 `POST /api/v1/card/bind` 接口
2. 填写请求体：
   ```json
   {
     "card_key": "A3KD-Q7LM-P2E8-W9RZ",
     "device_id": "device-001",
     "device_name": "测试设备"
   }
   ```
3. 点击 "Execute"

**2.4 查询我的权限**
1. 找到 `GET /api/v1/permission/my-permissions` 接口
2. 点击 "Try it out"
3. 点击 "Execute"
4. 查看返回的权限列表

**2.5 测试权限校验**
1. 找到 `POST /api/v1/permission/check` 接口
2. 填写请求体：
   ```json
   {
     "permission": "wechat"
   }
   ```
3. 点击 "Execute"
4. 预期：allowed=true

**2.6 测试没有的权限**
1. 使用相同的接口
2. 填写请求体：
   ```json
   {
     "permission": "douyin"
   }
   ```
3. 点击 "Execute"
4. 预期：allowed=false

**2.7 测试批量校验**
1. 找到 `POST /api/v1/permission/batch-check` 接口
2. 填写请求体：
   ```json
   {
     "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
   }
   ```
3. 点击 "Execute"
4. 查看返回的结果字典

---

## 🤖 使用自动化测试脚本

### 运行测试脚本
```bash
./test_permission_api.sh
```

这个脚本会自动执行：
1. ✅ 登录
2. ✅ 绑定卡密
3. ✅ 查询我的权限
4. ✅ 校验 wechat 权限（应该通过）
5. ✅ 校验 douyin 权限（应该失败）
6. ✅ 批量校验权限

---

## ✅ 测试检查清单

### 权限校验功能
- [ ] 查询我的权限成功
- [ ] 查询我的权限（未绑定卡密）返回空列表
- [ ] 校验拥有的权限返回 true
- [ ] 校验没有的权限返回 false
- [ ] 批量校验返回正确的结果字典

### 边界情况
- [ ] 未登录用户无法访问接口
- [ ] 未绑定卡密的用户返回 "未绑定卡密"
- [ ] 已过期的卡密无法通过验证
- [ ] 未绑定设备的用户无法通过验证
- [ ] 禁用的卡密无法通过验证

### 设备活跃时间
- [ ] 权限验证通过后，设备 last_active_at 更新

### 多卡密支持
- [ ] 绑定多个卡密后，权限为所有卡密的并集
- [ ] 任一卡密满足条件即可通过验证

---

## 🐛 常见问题

### Q1: 权限校验失败："未绑定卡密"
**原因**: 用户还没有绑定卡密

**解决**: 先调用绑定卡密接口

---

### Q2: 权限校验失败："该设备未绑定有效卡密"
**原因**: 当前设备没有绑定到卡密

**解决**: 
1. 检查 device_id 是否正确
2. 确保卡密绑定时使用了相同的 device_id

---

### Q3: 权限校验失败："没有有效的卡密或权限配置不匹配"
**原因**: 卡密不包含该权限

**解决**: 
1. 查询我的权限，确认有哪些权限
2. 绑定包含该权限的卡密

---

### Q4: Token 过期
**原因**: Token 有效期为 7 天

**解决**: 重新登录获取新的 token

---

## 📊 测试结果示例

### 成功案例

**查询我的权限**：
```json
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

**校验 wechat 权限**：
```json
{
  "allowed": true,
  "message": "权限验证通过",
  "expire_time": "2026-12-31T23:59:59"
}
```

**批量校验**：
```json
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false,
    "kuaishou": false
  }
}
```

### 失败案例

**未绑定卡密**：
```json
{
  "allowed": false,
  "message": "未绑定卡密",
  "expire_time": null
}
```

**卡密已过期**：
```json
{
  "allowed": false,
  "message": "没有有效的卡密或权限配置不匹配",
  "expire_time": null
}
```

---

## 🎓 学习建议

1. **先测试基础流程**: 登录 → 绑定 → 查询权限 → 校验权限
2. **再测试边界情况**: 未登录、未绑定、过期、不同设备
3. **最后测试批量功能**: 批量校验

---

## 📖 相关文档

- 阶段四完成总结：`app/docs/阶段四完成总结.md`
- 权限校验使用示例：`app/docs/权限校验使用示例.md`
- API 接口速查表：`app/docs/API接口速查表.md`

---

**祝测试顺利！** 🎉

如果遇到问题，请查看日志文件或联系开发团队。
