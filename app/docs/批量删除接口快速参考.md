# 批量删除接口快速参考

## 后端接口

### 1. 批量删除应用
```python
# 路由: POST /app/batch-delete
# 文件: app/api/endpoints/app.py
# 服务: app/services/app_service.py -> batch_delete_apps()

@router.post("/batch-delete")
async def batch_delete_apps(
    app_ids: List[int],
    current_admin: dict = Depends(get_current_admin),
    db: Session = Depends(get_db)
)
```

### 2. 批量删除用户
```python
# 路由: POST /auth/batch-delete-users
# 文件: app/api/endpoints/auth.py
# 服务: app/services/auth_service.py -> batch_delete_users()

@router.post("/batch-delete-users")
async def batch_delete_users(
    user_ids: List[int],
    current_admin: dict = Depends(get_current_admin),
    db: Session = Depends(get_db)
)
```

### 3. 批量删除卡密
```python
# 路由: POST /card/batch-delete
# 文件: app/api/endpoints/card.py
# 服务: app/services/card_service.py -> batch_delete_cards()

@router.post("/batch-delete")
async def batch_delete_cards(
    card_ids: List[int],
    current_admin: dict = Depends(get_current_admin),
    db: Session = Depends(get_db)
)
```

---

## 前端 API

### 1. 批量删除应用
```typescript
// 文件: web/admin-frontend/src/api/app.ts
export const batchDeleteApps = (appIds: number[]) => {
  return request.post('/app/batch-delete', appIds)
}
```

### 2. 批量删除用户
```typescript
// 文件: web/admin-frontend/src/api/auth.ts
export const batchDeleteUsers = (userIds: number[]) => {
  return request.post('/auth/batch-delete-users', userIds)
}
```

### 3. 批量删除卡密
```typescript
// 文件: web/admin-frontend/src/api/card.ts
export const batchDeleteCards = (cardIds: number[]) => {
  return request.post('/card/batch-delete', cardIds)
}
```

---

## 请求/响应格式

### 请求格式（所有接口相同）
```json
[1, 2, 3, 4, 5]
```

### 响应格式（所有接口相同）
```json
{
  "success": true,
  "message": "成功删除 5 个应用",
  "deleted_count": 5,
  "failed_ids": []
}
```

---

## 使用示例

### Vue 3 组件示例
```vue
<script setup lang="ts">
import { ref } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { batchDeleteApps } from '@/api/app'

const selectedIds = ref<number[]>([])

const handleBatchDelete = async () => {
  if (selectedIds.value.length === 0) {
    ElMessage.warning('请先选择要删除的项')
    return
  }
  
  try {
    await ElMessageBox.confirm(
      `确定要删除选中的 ${selectedIds.value.length} 项吗？`,
      '批量删除确认',
      { type: 'warning' }
    )
    
    const result = await batchDeleteApps(selectedIds.value)
    ElMessage.success(result.message)
    
    // 刷新数据
    await loadData()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('删除失败')
    }
  }
}
</script>
```

---

## 权限要求

所有批量删除接口都需要**管理员权限**，通过 `get_current_admin` 依赖注入验证。

---

## 特殊规则

1. **应用删除**: 会级联删除所有关联的卡密和Token
2. **用户删除**: 不允许删除管理员账户
3. **卡密删除**: 会级联删除所有用户绑定和设备绑定

---

## 测试命令

```bash
# 运行测试脚本
python test_batch_delete_apis.py
```
