# 通用卡密与授权系统 - 使用手册

## 📖 目录

1. [系统简介](#系统简介)
2. [快速开始](#快速开始)
3. [基础使用](#基础使用)
4. [管理员功能](#管理员功能)
5. [高级功能](#高级功能)
6. [故障排查](#故障排查)

---

## 系统简介

### 什么是卡密授权系统？

卡密授权系统是一种常见的软件授权方式，用户通过购买卡密来获得软件的使用权限。本系统提供了完整的卡密管理和权限校验功能。

### 核心概念

- **卡密(Card)**: 类似激活码，格式如 `A3KD-Q7LM-P2E8-W9RZ`
- **权限(Permission)**: 卡密包含的功能权限，如 `["wechat", "ximalaya"]`
- **设备(Device)**: 用户的电脑或手机，通过设备ID标识
- **应用(App)**: 不同的软件产品，一个系统可以管理多个应用

### 业务流程

```
1. 用户注册账号
2. 用户登录获取Token
3. 用户购买并绑定卡密
4. 应用程序调用权限校验接口
5. 系统验证用户权限
6. 返回是否有权限使用该功能
```

---

## 快速开始

### 1. 部署系统

```bash
# 克隆项目
git clone <repository>
cd login-km-system

# 安装依赖
pip install -r requirements.txt

# 配置环境
cp .env.example .env
# 编辑 .env 配置数据库

# 初始化数据库
python -m app.scripts.set_env dev upgrade

# 创建管理员
python app/scripts/create_admin_user.py

# 启动服务
python run_app.py
```

### 2. 访问文档

- **API文档**: http://localhost:9999/docs
- **ReDoc文档**: http://localhost:9999/redoc

### 3. 第一次使用

1. 使用管理员账号登录 (admin / admin123)
2. 创建一个应用
3. 生成一些卡密
4. 注册一个普通用户
5. 绑定卡密
6. 测试权限校验

---

## 基础使用

### 用户注册

**接口**: `POST /api/v1/auth/register`

```bash
curl -X POST http://localhost:9999/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "myuser",
    "password": "mypassword123"
  }'
```

**响应**:
```json
{
  "id": 1,
  "username": "myuser",
  "status": "normal"
}
```

### 用户登录

**接口**: `POST /api/v1/auth/login`

```bash
curl -X POST http://localhost:9999/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "myuser",
    "password": "mypassword123",
    "app_key": "wx_crawler_app",
    "device_id": "my-computer-001"
  }'
```

**响应**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user_status": "normal",
  "has_card": false,
  "username": "myuser",
  "role": "user"
}
```

**重要**: 保存返回的 `token`，后续所有需要认证的接口都需要使用它。

### 查询我的卡密

**接口**: `GET /api/v1/card/my`

```bash
curl -X GET http://localhost:9999/api/v1/card/my \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 绑定卡密

**接口**: `POST /api/v1/card/bind`

```bash
curl -X POST http://localhost:9999/api/v1/card/bind \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_key": "A3KD-Q7LM-P2E8-W9RZ",
    "device_id": "my-computer-001",
    "device_name": "我的电脑"
  }'
```

### 权限校验

**接口**: `POST /api/v1/permission/check`

```bash
curl -X POST http://localhost:9999/api/v1/permission/check \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permission": "wechat",
    "device_id": "my-computer-001"
  }'
```

**响应**:
```json
{
  "allowed": true,
  "message": "权限验证通过",
  "expire_time": "2027-01-01T00:00:00"
}
```

---

## 管理员功能

### 登录管理员账号

使用管理员账号登录获取管理员Token：

```bash
curl -X POST http://localhost:9999/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "app_key": "wx_crawler_app",
    "device_id": "admin-device-001"
  }'
```

### 批量生成卡密

**接口**: `POST /api/v1/admin/card/generate`

```bash
curl -X POST http://localhost:9999/api/v1/admin/card/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -d '{
    "app_id": 1,
    "count": 100,
    "expire_time": "2027-12-31T23:59:59",
    "max_device_count": 2,
    "permissions": ["wechat", "ximalaya"],
    "remark": "标准套餐"
  }'
```

**响应**:
```json
{
  "success": true,
  "message": "成功生成 100 个卡密",
  "count": 100,
  "cards": ["A3KD-...", "B7MN-...", ...]
}
```

### 查询用户列表

```bash
curl -X GET "http://localhost:9999/api/v1/admin/users?page=1&size=20" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### 封禁用户

```bash
curl -X PUT "http://localhost:9999/api/v1/admin/user/3/status?status=banned" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### 查询卡密列表

```bash
# 查询未使用的卡密
curl -X GET "http://localhost:9999/api/v1/admin/cards?status=unused&page=1&size=20" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 关键词搜索
curl -X GET "http://localhost:9999/api/v1/admin/cards?keyword=A3KD&page=1&size=10" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### 实时修改卡密权限

**这是本系统的核心功能！修改后立即对所有用户生效，无需重启服务器。**

```bash
curl -X PUT http://localhost:9999/api/v1/admin/card/1/permissions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin"]
  }'
```

修改完成后，用户立即可以使用新增的权限，被删除的权限立即失效。

### 查询设备列表

```bash
# 查询某个卡密的所有设备
curl -X GET "http://localhost:9999/api/v1/admin/devices?card_id=1" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### 禁用设备

```bash
curl -X PUT http://localhost:9999/api/v1/admin/device/1/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -d '{"status": "disabled"}'
```

### 获取统计数据

```bash
curl -X GET http://localhost:9999/api/v1/admin/statistics \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

**响应**:
```json
{
  "users": {
    "total": 100,
    "normal": 95,
    "banned": 5
  },
  "cards": {
    "total": 500,
    "unused": 300,
    "used": 180,
    "disabled": 20
  },
  "devices": {
    "total": 350,
    "active": 330,
    "disabled": 20
  },
  "apps": {
    "total": 3,
    "active": 3
  }
}
```

---

## 高级功能

### 权限格式

系统支持两种权限配置格式：

#### 列表格式（简单）

```json
["wechat", "ximalaya", "douyin"]
```

**校验逻辑**: permission in permissions

#### 字典格式（灵活）

```json
{
  "wechat": true,
  "ximalaya": true,
  "douyin": false,
  "kuaishou": false
}
```

**校验逻辑**: permissions.get(permission) == true

### 批量权限校验

一次性检查多个权限：

```bash
curl -X POST http://localhost:9999/api/v1/permission/batch-check \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
  }'
```

**响应**:
```json
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false,
    "kuaishou": false
  }
}
```

### 使用权限装饰器

在你的FastAPI路由中使用权限装饰器：

```python
from app.decorators.permission_decorator import require_permission
from fastapi import APIRouter, Depends

router = APIRouter()

@router.get("/wx/search")
@require_permission("wechat")
async def search_wechat(
    query: str,
    current_user: dict = Depends(get_current_user)
):
    # 只有拥有wechat权限的用户才能访问
    return {"results": []}
```

### 多设备管理

每个卡密可以设置最大设备数：

- 设备数 = 1: 只能在一台设备使用
- 设备数 = 2: 可以在两台设备使用
- 设备数 = 无限制: 可以设置很大的数字

**解绑设备**:

```bash
curl -X POST http://localhost:9999/api/v1/card/unbind-device \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_id": 1,
    "device_id": "old-device-001"
  }'
```

---

## 故障排查

### 1. 权限校验失败

**问题**: 调用权限校验返回 `allowed: false`

**排查步骤**:

1. 检查用户是否已登录
   ```bash
   curl -X GET http://localhost:9999/api/v1/card/my \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

2. 检查是否绑定了卡密
   - 如果 `has_card: false`，需要先绑定卡密

3. 检查卡密是否过期
   - 查看 `expire_time` 是否在当前时间之后

4. 检查设备是否绑定
   - 使用的 `device_id` 必须与绑定时一致

5. 检查权限配置
   - 卡密的 `permissions` 中是否包含你要校验的权限

### 2. 绑定卡密失败

**常见原因**:

- **卡密不存在**: 检查卡密是否输入正确
- **卡密已过期**: 联系管理员
- **卡密已被禁用**: 联系管理员
- **设备数量超限**: 需要先解绑其他设备

### 3. 登录失败

**常见原因**:

- **用户名或密码错误**: 检查输入
- **用户已被封禁**: 联系管理员
- **应用不存在**: 检查 `app_key` 是否正确
- **应用已禁用**: 联系管理员

### 4. Token失效

**原因**:

- Token已过期（默认7天）
- Token已被删除（登出或重新登录）
- 数据库中Token记录被删除

**解决**: 重新登录获取新Token

### 5. 管理接口返回403

**原因**: 当前用户不是管理员

**解决**:
```bash
# 将用户升级为管理员
python app/scripts/create_admin_user.py username password
```

---

## 最佳实践

### 客户端集成

#### 1. 初始化

```python
class AuthClient:
    def __init__(self, base_url, app_key):
        self.base_url = base_url
        self.app_key = app_key
        self.token = None
        self.device_id = self._get_device_id()
    
    def _get_device_id(self):
        """获取设备唯一标识"""
        import uuid
        # 可以基于硬件信息生成
        return str(uuid.uuid4())
```

#### 2. 用户登录

```python
def login(self, username, password):
    response = requests.post(
        f"{self.base_url}/api/v1/auth/login",
        json={
            "username": username,
            "password": password,
            "app_key": self.app_key,
            "device_id": self.device_id
        }
    )
    
    if response.status_code == 200:
        data = response.json()
        self.token = data["token"]
        return True
    return False
```

#### 3. 权限校验

```python
def check_permission(self, permission):
    response = requests.post(
        f"{self.base_url}/api/v1/permission/check",
        headers={"Authorization": f"Bearer {self.token}"},
        json={
            "permission": permission,
            "device_id": self.device_id
        }
    )
    
    if response.status_code == 200:
        data = response.json()
        return data.get("allowed", False)
    return False
```

#### 4. 完整示例

```python
# 初始化客户端
client = AuthClient("http://localhost:9999", "wx_crawler_app")

# 登录
if client.login("myuser", "mypassword123"):
    print("登录成功")
    
    # 检查权限
    if client.check_permission("wechat"):
        print("有微信权限，可以使用功能")
        # 执行业务逻辑
    else:
        print("没有微信权限")
else:
    print("登录失败")
```

### 错误处理

```python
def safe_check_permission(self, permission):
    try:
        return self.check_permission(permission)
    except requests.exceptions.ConnectionError:
        print("网络连接失败")
        return False
    except requests.exceptions.Timeout:
        print("请求超时")
        return False
    except Exception as e:
        print(f"未知错误: {e}")
        return False
```

### Token刷新

Token默认有效期7天，建议：

1. 本地缓存Token和过期时间
2. 每次启动检查Token是否过期
3. 过期前自动重新登录
4. Token失效时提示用户重新登录

---

## 管理员操作指南

### 套餐设计

根据业务需求设计不同套餐：

**基础套餐**:
```json
{
  "expire_time": "2027-01-01T00:00:00",
  "max_device_count": 1,
  "permissions": ["wechat"],
  "remark": "基础套餐-单设备-微信"
}
```

**标准套餐**:
```json
{
  "expire_time": "2027-01-01T00:00:00",
  "max_device_count": 2,
  "permissions": ["wechat", "ximalaya"],
  "remark": "标准套餐-双设备-微信+喜马拉雅"
}
```

**高级套餐**:
```json
{
  "expire_time": "2027-12-31T23:59:59",
  "max_device_count": 3,
  "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"],
  "remark": "高级套餐-三设备-全功能"
}
```

### 卡密分发

1. 批量生成卡密
2. 导出卡密列表
3. 通过邮件/网站发送给用户
4. 用户自行绑定

### 用户管理

**处理违规用户**:
1. 查询用户列表，找到违规用户
2. 封禁用户账号
3. 禁用其绑定的设备
4. 用户无法再登录和使用

**解封用户**:
1. 更新用户状态为 normal
2. 启用设备状态
3. 用户可以正常登录

### 权限动态调整

**场景**: 需要临时给某些用户增加功能

1. 找到用户绑定的卡密ID
2. 修改卡密权限
3. 立即生效，无需通知用户

```bash
# 增加权限
curl -X PUT http://localhost:9999/api/v1/admin/card/1/permissions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
  }'
```

### 数据导出

**导出卡密**:
```bash
# 查询所有未使用的卡密
curl -X GET "http://localhost:9999/api/v1/admin/cards?status=unused&page=1&size=1000" \
  -H "Authorization: Bearer ADMIN_TOKEN" > unused_cards.json
```

**导出用户列表**:
```bash
curl -X GET "http://localhost:9999/api/v1/admin/users?page=1&size=1000" \
  -H "Authorization: Bearer ADMIN_TOKEN" > users.json
```

---

## 开发集成

### Python集成

```python
import requests

class CardAuthClient:
    def __init__(self, api_url, app_key):
        self.api_url = api_url
        self.app_key = app_key
        self.token = None
    
    def login(self, username, password, device_id):
        """用户登录"""
        resp = requests.post(f"{self.api_url}/auth/login", json={
            "username": username,
            "password": password,
            "app_key": self.app_key,
            "device_id": device_id
        })
        if resp.status_code == 200:
            self.token = resp.json()["token"]
            return True
        return False
    
    def check_permission(self, permission, device_id):
        """检查权限"""
        resp = requests.post(
            f"{self.api_url}/permission/check",
            headers={"Authorization": f"Bearer {self.token}"},
            json={
                "permission": permission,
                "device_id": device_id
            }
        )
        if resp.status_code == 200:
            return resp.json()["allowed"]
        return False

# 使用示例
client = CardAuthClient("http://localhost:9999/api/v1", "wx_crawler_app")
if client.login("user1", "pass123", "device-001"):
    if client.check_permission("wechat", "device-001"):
        print("有权限，执行功能")
```

### JavaScript集成

```javascript
class CardAuthClient {
    constructor(apiUrl, appKey) {
        this.apiUrl = apiUrl;
        this.appKey = appKey;
        this.token = null;
    }
    
    async login(username, password, deviceId) {
        const resp = await fetch(`${this.apiUrl}/auth/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username,
                password,
                app_key: this.appKey,
                device_id: deviceId
            })
        });
        
        if (resp.ok) {
            const data = await resp.json();
            this.token = data.token;
            return true;
        }
        return false;
    }
    
    async checkPermission(permission, deviceId) {
        const resp = await fetch(`${this.apiUrl}/permission/check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            },
            body: JSON.stringify({ permission, device_id: deviceId })
        });
        
        if (resp.ok) {
            const data = await resp.json();
            return data.allowed;
        }
        return false;
    }
}

// 使用示例
const client = new CardAuthClient('http://localhost:9999/api/v1', 'wx_crawler_app');
await client.login('user1', 'pass123', 'device-001');
const hasPermission = await client.checkPermission('wechat', 'device-001');
```

---

## 性能优化

### 缓存使用

系统内置了缓存机制，权限校验等操作会自动缓存：

- **首次调用**: ~50ms (数据库查询)
- **缓存命中**: ~5ms (10倍提升)

**缓存策略**:
- 用户信息: 15分钟
- 权限校验: 5分钟
- 卡密信息: 10分钟

### 并发处理

系统支持高并发访问：

- 异步处理
- 数据库连接池
- 缓存减少数据库压力

**建议配置**:
- 数据库连接池: 10-50
- Uvicorn workers: 根据CPU核心数

---

## 安全建议

1. **密钥安全**
   - 修改 `.env` 中的 `SECRET_KEY`
   - 使用强随机密钥
   - 定期更换密钥

2. **数据库安全**
   - 不要使用root账号
   - 配置合适的权限
   - 定期备份数据

3. **Token安全**
   - Token不要分享给他人
   - HTTPS传输
   - 定期更新Token

4. **管理员账号**
   - 使用强密码
   - 限制管理员数量
   - 记录管理员操作日志

---

## 常见问题

### Q: 如何创建多个应用？

A: 使用管理员账号调用创建应用接口：
```bash
curl -X POST http://localhost:9999/api/v1/app/create \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -d '{"app_name": "新应用"}'
```

### Q: 卡密可以重复使用吗？

A: 不可以。每个卡密只能被一个用户绑定一次。如果需要多用户使用，需要生成多个卡密。

### Q: 如何限制用户只能在一台设备使用？

A: 在生成卡密时设置 `max_device_count: 1`

### Q: 如何实现续费？

A: 有两种方式：
1. 生成新卡密，用户绑定新卡密（权限叠加）
2. 管理员直接修改现有卡密的过期时间（需要数据库操作）

### Q: 权限修改需要重启服务器吗？

A: 不需要！这是本系统的核心优势。管理员修改卡密权限后，立即对所有用户生效。

### Q: 如何批量导入卡密？

A: 使用批量生成接口，一次可以生成1-1000个卡密。

---

## 技术支持

- **文档**: `app/docs/` 目录下的所有文档
- **API文档**: http://localhost:9999/docs
- **测试用例**: `tests/` 目录

---

> **版本**: 1.0.0
> 
> **状态**: 生产环境就绪 ✅
> 
> **更新时间**: 2026-01-29
