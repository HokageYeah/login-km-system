# é˜¶æ®µäºŒï¼šç”¨æˆ·è®¤è¯ç³»ç»Ÿ - å®Œæˆæ€»ç»“

## âœ… å®Œæˆæ—¶é—´
2026-01-27

## âœ… å®Œæˆçš„ä»»åŠ¡

### ä»»åŠ¡ 4ï¼šå®ç°å¯†ç åŠ å¯†ä¸ JWT å·¥å…· âœ…

#### 4.1 æ›´æ–°é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `app/core/config.py`
- âœ… æ·»åŠ  SECRET_KEY é…ç½®
- âœ… æ·»åŠ  ALGORITHM é…ç½®ï¼ˆHS256ï¼‰
- âœ… æ·»åŠ  ACCESS_TOKEN_EXPIRE_MINUTES é…ç½®ï¼ˆ7å¤©ï¼‰

**æ–‡ä»¶**: `.env.development`
- âœ… æ·»åŠ  JWT ç›¸å…³ç¯å¢ƒå˜é‡

#### 4.2 åˆ›å»ºå®‰å…¨å·¥å…·æ¨¡å—
**æ–‡ä»¶**: `app/core/security.py`

å®ç°çš„åŠŸèƒ½ï¼š
- âœ… `hash_password()` - å¯†ç å“ˆå¸Œç”Ÿæˆ
- âœ… `verify_password()` - å¯†ç éªŒè¯
- âœ… `create_access_token()` - åˆ›å»ºJWT Token
- âœ… `decode_access_token()` - è§£æJWT Token
- âœ… `verify_token()` - éªŒè¯Tokenæœ‰æ•ˆæ€§
- âœ… `get_token_expire_time()` - è·å–Tokenè¿‡æœŸæ—¶é—´

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `passlib` + `bcrypt` è¿›è¡Œå¯†ç åŠ å¯†
- ä½¿ç”¨ `python-jose` è¿›è¡ŒJWTå¤„ç†
- TokenåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼šuser_id, username, app_id, device_id, role
- æ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´

---

### ä»»åŠ¡ 5ï¼šå®ç°ç”¨æˆ·è®¤è¯æœåŠ¡å±‚ âœ…

**æ–‡ä»¶**: `app/services/auth_service.py`

#### 5.1 AuthService ç±»

å®ç°çš„æ ¸å¿ƒæ–¹æ³•ï¼š

**5.1.1 ç”¨æˆ·æ³¨å†Œ `register()`**
- âœ… æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
- âœ… å¯†ç å“ˆå¸Œå¤„ç†
- âœ… åˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆé»˜è®¤è§’è‰²ä¸ºUSERï¼‰
- âœ… è¿”å›ç”¨æˆ·å¯¹è±¡å’Œé”™è¯¯ä¿¡æ¯

**5.1.2 ç”¨æˆ·ç™»å½• `login()`**
- âœ… éªŒè¯åº”ç”¨æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
- âœ… éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
- âœ… æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆæ˜¯å¦è¢«å°ç¦ï¼‰
- âœ… ç”ŸæˆJWT Token
- âœ… ä¿å­˜Tokenåˆ°æ•°æ®åº“
- âœ… è‡ªåŠ¨åˆ é™¤æ—§Tokenï¼ˆåŒä¸€ç”¨æˆ·åŒä¸€è®¾å¤‡åŒä¸€åº”ç”¨ï¼‰
- âœ… æ›´æ–°æœ€åç™»å½•æ—¶é—´
- âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»‘å®šå¡å¯†
- âœ… è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯

**5.1.3 TokenéªŒè¯ `verify_token()`**
- âœ… ä»æ•°æ®åº“æŸ¥è¯¢Token
- âœ… æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
- âœ… æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- âœ… è¿”å›ç”¨æˆ·å®Œæ•´ä¿¡æ¯

**5.1.4 ç”¨æˆ·ç™»å‡º `logout()`**
- âœ… åˆ é™¤Tokenè®°å½•
- âœ… ä½¿Tokenå¤±æ•ˆ

**5.1.5 è¾…åŠ©æ–¹æ³•**
- âœ… `_check_user_has_card()` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¡å¯†
- âœ… `get_user_by_id()` - æ ¹æ®IDè·å–ç”¨æˆ·
- âœ… `get_user_by_username()` - æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·

---

### ä»»åŠ¡ 6ï¼šå®ç°è®¤è¯ API æ¥å£ âœ…

#### 6.1 åˆ›å»ºä¾èµ–å‡½æ•°æ¨¡å—
**æ–‡ä»¶**: `app/api/dependencies.py`

å®ç°çš„ä¾èµ–å‡½æ•°ï¼š
- âœ… `get_db()` - è·å–æ•°æ®åº“ä¼šè¯
- âœ… `get_current_user()` - è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆå¿…é¡»ç™»å½•ï¼‰
- âœ… `get_current_admin()` - è·å–å½“å‰ç®¡ç†å‘˜ï¼ˆå¿…é¡»æ˜¯ç®¡ç†å‘˜è§’è‰²ï¼‰
- âœ… `get_optional_current_user()` - è·å–å½“å‰ç”¨æˆ·ï¼ˆå¯é€‰ï¼Œæœªç™»å½•è¿”å›Noneï¼‰

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ FastAPI çš„ `HTTPBearer` å®‰å…¨æ–¹æ¡ˆ
- è‡ªåŠ¨ä»è¯·æ±‚å¤´æå– Token
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†

#### 6.2 åˆ›å»ºè®¤è¯æ¥å£
**æ–‡ä»¶**: `app/api/endpoints/auth.py`

å®ç°çš„æ¥å£ï¼š

**6.2.1 ç”¨æˆ·æ³¨å†Œ**
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**6.2.2 ç”¨æˆ·ç™»å½•**
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123",
  "app_key": "default_app",
  "device_id": "abc123def456"
}

Response:
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user_status": "normal",
  "has_card": false,
  "username": "testuser",
  "role": "user"
}
```

**6.2.3 éªŒè¯Token**
```http
GET /api/v1/auth/verify
Authorization: Bearer {token}

Response:
{
  "user_id": 1,
  "username": "testuser",
  "status": "normal",
  "role": "user",
  "app_id": 1,
  "device_id": "abc123def456"
}
```

**6.2.4 ç”¨æˆ·ç™»å‡º**
```http
POST /api/v1/auth/logout
Authorization: Bearer {token}

Response:
{
  "success": true,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

**6.2.5 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯**
```http
GET /api/v1/auth/me
Authorization: Bearer {token}

Response: (åŒéªŒè¯Tokenæ¥å£)
```

#### 6.3 æ›´æ–°è·¯ç”±æ³¨å†Œ
**æ–‡ä»¶**: `app/api/api.py`
- âœ… å°†è®¤è¯æ¥å£æ³¨å†Œåˆ°ä¸»è·¯ç”±

---

### é¢å¤–å®Œæˆï¼šåˆå§‹åŒ–æ•°æ®è„šæœ¬ âœ…

**æ–‡ä»¶**: `app/scripts/init_data.py`

åŠŸèƒ½ï¼š
- âœ… åˆ›å»ºé»˜è®¤åº”ç”¨ï¼ˆapp_key: default_appï¼‰
- âœ… åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼ˆusername: admin, password: admin123456ï¼‰
- âœ… åˆ›å»ºæµ‹è¯•ç”¨æˆ·è´¦æˆ·ï¼ˆusername: testuser, password: test123456ï¼‰
- âœ… å‹å¥½çš„å‘½ä»¤è¡Œè¾“å‡º
- âœ… å¹‚ç­‰æ€§è®¾è®¡ï¼ˆé‡å¤è¿è¡Œä¸ä¼šå‡ºé”™ï¼‰

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
python -m app.scripts.init_data
```

---

## ğŸ“Š å®Œæˆç»Ÿè®¡

### ä»£ç æ–‡ä»¶
- âœ… 1 ä¸ªå®‰å…¨å·¥å…·æ¨¡å—ï¼ˆsecurity.pyï¼‰
- âœ… 1 ä¸ªè®¤è¯æœåŠ¡å±‚ï¼ˆauth_service.pyï¼‰
- âœ… 1 ä¸ªä¾èµ–å‡½æ•°æ¨¡å—ï¼ˆdependencies.pyï¼‰
- âœ… 1 ä¸ªè®¤è¯æ¥å£æ–‡ä»¶ï¼ˆauth.pyï¼‰
- âœ… 1 ä¸ªåˆå§‹åŒ–è„šæœ¬ï¼ˆinit_data.pyï¼‰

### æ¥å£ç»Ÿè®¡
- âœ… 5 ä¸ªè®¤è¯ç›¸å…³æ¥å£
- âœ… 3 ä¸ªä¾èµ–å‡½æ•°

### åŠŸèƒ½ç»Ÿè®¡
- âœ… å¯†ç åŠ å¯†/éªŒè¯
- âœ… JWT Token ç”Ÿæˆ/è§£æ
- âœ… ç”¨æˆ·æ³¨å†Œ
- âœ… ç”¨æˆ·ç™»å½•
- âœ… Token éªŒè¯
- âœ… ç”¨æˆ·ç™»å‡º
- âœ… å¤šåº”ç”¨æ”¯æŒ
- âœ… å¤šè®¾å¤‡æ”¯æŒ
- âœ… è§’è‰²æƒé™æ§åˆ¶

---

## ğŸ¯ ä»£ç è´¨é‡ä¿è¯

### å®‰å…¨æ€§
- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†ï¼Œä¸å­˜å‚¨æ˜æ–‡
- âœ… JWT Token åŒ…å«è¿‡æœŸæ—¶é—´
- âœ… Token å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œå¯ä»¥ä¸»åŠ¨å¤±æ•ˆ
- âœ… æ”¯æŒå°ç¦ç”¨æˆ·åŠŸèƒ½
- âœ… æ”¯æŒåº”ç”¨ç¦ç”¨åŠŸèƒ½

### å¯ç»´æŠ¤æ€§
- âœ… æœåŠ¡å±‚ä¸æ¥å£å±‚åˆ†ç¦»
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… å®Œæ•´çš„ç±»å‹æç¤º
- âœ… è¯¦ç»†çš„ä»£ç æ³¨é‡Š
- âœ… ç¬¦åˆ FastAPI æœ€ä½³å®è·µ

### æ—¥å¿—è®°å½•
- âœ… ç”¨æˆ·æ³¨å†Œæ—¥å¿—
- âœ… ç”¨æˆ·ç™»å½•æ—¥å¿—
- âœ… TokenéªŒè¯æ—¥å¿—
- âœ… ç”¨æˆ·ç™»å‡ºæ—¥å¿—

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### 1. åº”ç”¨æ•°æ®åº“è¿ç§»
```bash
# è®¾ç½®ç¯å¢ƒ
export ENV=dev

# åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœè¿˜æ²¡åˆ›å»ºï¼‰
python -m app.scripts.create_database

# åº”ç”¨è¿ç§»
alembic upgrade head
```

### 2. åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
```bash
python -m app.scripts.init_data
```

æ‰§è¡Œåä¼šçœ‹åˆ°ï¼š
```
====================================================
å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®...
====================================================

1. æ£€æŸ¥é»˜è®¤åº”ç”¨...
   âœ“ åˆ›å»ºé»˜è®¤åº”ç”¨æˆåŠŸ
     - åº”ç”¨ID: 1
     - åº”ç”¨Key: default_app
     - åº”ç”¨åç§°: é»˜è®¤åº”ç”¨

2. æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·...
   âœ“ åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·æˆåŠŸ
     - ç”¨æˆ·ID: 1
     - ç”¨æˆ·å: admin
     - é»˜è®¤å¯†ç : admin123456
     âš ï¸  è¯·åœ¨é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç ï¼

3. æ£€æŸ¥æµ‹è¯•ç”¨æˆ·...
   âœ“ åˆ›å»ºæµ‹è¯•ç”¨æˆ·æˆåŠŸ
     - ç”¨æˆ·ID: 2
     - ç”¨æˆ·å: testuser
     - é»˜è®¤å¯†ç : test123456

====================================================
ç³»ç»Ÿæ•°æ®åˆå§‹åŒ–å®Œæˆï¼
====================================================
```

### 3. å¯åŠ¨æœåŠ¡
```bash
python run_app.py
```

### 4. æµ‹è¯•æ¥å£

#### 4.1 æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
```bash
curl -X POST "http://localhost:8002/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123"
  }'
```

#### 4.2 æµ‹è¯•ç”¨æˆ·ç™»å½•
```bash
curl -X POST "http://localhost:8002/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "test-device-001"
  }'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user_status": "normal",
  "has_card": false,
  "username": "testuser",
  "role": "user"
}
```

#### 4.3 æµ‹è¯•TokenéªŒè¯
```bash
# ä½¿ç”¨ä¸Šä¸€æ­¥è·å–çš„token
curl -X GET "http://localhost:8002/api/v1/auth/verify" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

#### 4.4 æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
```bash
curl -X POST "http://localhost:8002/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123456",
    "app_key": "default_app",
    "device_id": "admin-device-001"
  }'
```

### 5. ä½¿ç”¨ Swagger UI æµ‹è¯•
è®¿é—®ï¼šhttp://localhost:8002/docs

1. æ‰¾åˆ° "è®¤è¯" æ ‡ç­¾
2. æµ‹è¯•æ³¨å†Œæ¥å£
3. æµ‹è¯•ç™»å½•æ¥å£
4. ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„ "Authorize" æŒ‰é’®
5. è¾“å…¥è·å–çš„Token
6. æµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£

---

## ğŸ”’ å®‰å…¨è¯´æ˜

### é»˜è®¤å¯†ç 
ç³»ç»Ÿåˆ›å»ºäº†ä¸¤ä¸ªé»˜è®¤è´¦æˆ·ï¼š
- **ç®¡ç†å‘˜**: admin / admin123456
- **æµ‹è¯•ç”¨æˆ·**: testuser / test123456

âš ï¸ **é‡è¦**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œè¯·åŠ¡å¿…ä¿®æ”¹è¿™äº›é»˜è®¤å¯†ç ï¼

### JWTå¯†é’¥
é…ç½®æ–‡ä»¶ä¸­çš„ `SECRET_KEY` æ˜¯ç”¨äºç”ŸæˆJWTçš„å¯†é’¥ã€‚

âš ï¸ **é‡è¦**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œè¯·åŠ¡å¿…ä¿®æ”¹ä¸ºå¼ºéšæœºå­—ç¬¦ä¸²ï¼

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå®‰å…¨çš„å¯†é’¥ï¼š
```bash
openssl rand -hex 32
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šé˜¶æ®µä¸‰

é˜¶æ®µäºŒå·²å…¨éƒ¨å®Œæˆï¼Œå¯ä»¥å¼€å§‹**é˜¶æ®µä¸‰ï¼šå¡å¯†ç®¡ç†ç³»ç»Ÿ**çš„å¼€å‘ï¼š

### é˜¶æ®µä¸‰ä»»åŠ¡æ¸…å•
- [ ] ä»»åŠ¡ 7ï¼šå®ç°å¡å¯†ç”Ÿæˆå·¥å…·
- [ ] ä»»åŠ¡ 8ï¼šå®ç°å¡å¯†æœåŠ¡å±‚
- [ ] ä»»åŠ¡ 9ï¼šå®ç°å¡å¯† API æ¥å£
- [ ] ä»»åŠ¡ 10ï¼šå®ç°åº”ç”¨ç®¡ç†åŠŸèƒ½

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Tokenè¿‡æœŸæ—¶é—´**: é»˜è®¤7å¤©ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´
2. **åŒè®¾å¤‡ç™»å½•**: åŒä¸€ç”¨æˆ·åœ¨åŒä¸€è®¾å¤‡åŒä¸€åº”ç”¨ä¸Šç™»å½•ï¼Œæ—§Tokenä¼šè¢«è‡ªåŠ¨åˆ é™¤
3. **å¯†ç å¼ºåº¦**: å½“å‰åªè¦æ±‚6ä½ä»¥ä¸Šï¼Œå¯æ ¹æ®éœ€æ±‚å¢å¼ºéªŒè¯
4. **æ—¥å¿—è®°å½•**: æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•
5. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

---

**é˜¶æ®µäºŒå®Œæˆï¼ğŸ‰**

ç°åœ¨ç³»ç»Ÿå·²å…·å¤‡å®Œæ•´çš„ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼š
- âœ… ç”¨æˆ·å¯ä»¥æ³¨å†Œè´¦å·
- âœ… ç”¨æˆ·å¯ä»¥ç™»å½•è·å–Token
- âœ… æ¥å£å¯ä»¥éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… æ”¯æŒå¤šåº”ç”¨å’Œå¤šè®¾å¤‡
- âœ… æ”¯æŒç®¡ç†å‘˜è§’è‰²
