# æƒé™æ ¡éªŒä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£å±•ç¤ºå¦‚ä½•åœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨æƒé™æ ¡éªŒç³»ç»Ÿã€‚

---

## ğŸ“š ç›®å½•

1. [åŸºç¡€ä½¿ç”¨](#åŸºç¡€ä½¿ç”¨)
2. [è£…é¥°å™¨æ–¹å¼](#è£…é¥°å™¨æ–¹å¼)
3. [ä¾èµ–æ³¨å…¥æ–¹å¼](#ä¾èµ–æ³¨å…¥æ–¹å¼)
4. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## åŸºç¡€ä½¿ç”¨

### åœºæ™¯ï¼šå®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æƒé™æ ¡éªŒæ¥å£

é€‚ç”¨äºï¼šæ¡Œé¢åº”ç”¨ã€ç§»åŠ¨åº”ç”¨

```python
# å®¢æˆ·ç«¯ä¼ªä»£ç 
import requests

# 1. ç™»å½•è·å– token
response = requests.post("http://localhost:8003/api/v1/auth/login", json={
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-001"
})
token = response.json()["token"]

# 2. åœ¨æ‰§è¡Œä¸šåŠ¡æ“ä½œå‰ï¼Œå…ˆæ£€æŸ¥æƒé™
check_response = requests.post(
    "http://localhost:8003/api/v1/permission/check",
    headers={"Authorization": f"Bearer {token}"},
    json={"permission": "wechat"}
)

if check_response.json()["allowed"]:
    # æœ‰æƒé™ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘
    print("å¼€å§‹æ‰§è¡Œå¾®ä¿¡ç›¸å…³åŠŸèƒ½...")
else:
    # æ²¡æœ‰æƒé™ï¼Œæç¤ºç”¨æˆ·
    print(f"æ²¡æœ‰æƒé™: {check_response.json()['message']}")
```

---

## è£…é¥°å™¨æ–¹å¼

### åœºæ™¯ï¼šåç«¯APIè‡ªåŠ¨éªŒè¯æƒé™

é€‚ç”¨äºï¼šWeb APIã€å†…éƒ¨æœåŠ¡

```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.decorators import require_permission
from app.api.dependencies import get_current_user, get_db

router = APIRouter()

@router.get("/wx/search")
@require_permission("wechat")
async def search_wechat(
    query: str,
    current_user: dict = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    å¾®ä¿¡æœç´¢æ¥å£
    
    ä½¿ç”¨ @require_permission è£…é¥°å™¨è‡ªåŠ¨éªŒè¯æƒé™
    å¦‚æœç”¨æˆ·æ²¡æœ‰ wechat æƒé™ï¼Œä¼šè‡ªåŠ¨è¿”å› 403 é”™è¯¯
    """
    # å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æƒé™éªŒè¯å·²é€šè¿‡
    username = current_user["username"]
    
    # æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    results = perform_wechat_search(query)
    
    return {
        "query": query,
        "user": username,
        "results": results
    }


@router.get("/ximalaya/download")
@require_permission("ximalaya")
async def download_ximalaya(
    audio_id: str,
    current_user: dict = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    å–œé©¬æ‹‰é›…ä¸‹è½½æ¥å£
    
    éœ€è¦ ximalaya æƒé™
    """
    # æƒé™å·²éªŒè¯ï¼Œæ‰§è¡Œä¸‹è½½é€»è¾‘
    file_url = download_audio(audio_id)
    
    return {"file_url": file_url}
```

---

## ä¾èµ–æ³¨å…¥æ–¹å¼

### åœºæ™¯ï¼šæ›´ç¬¦åˆ FastAPI é£æ ¼

æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä»£ç æ›´æ¸…æ™°ã€‚

```python
from fastapi import APIRouter, Depends

from app.decorators.permission_decorator import (
    require_wechat,
    require_ximalaya,
    create_permission_dependency
)

router = APIRouter()


@router.get("/wx/search")
async def search_wechat(
    query: str,
    _: None = Depends(require_wechat)  # ä½¿ç”¨é¢„å®šä¹‰çš„ä¾èµ–
):
    """
    å¾®ä¿¡æœç´¢æ¥å£
    
    ä½¿ç”¨é¢„å®šä¹‰çš„ require_wechat ä¾èµ–
    """
    results = perform_wechat_search(query)
    return {"results": results}


@router.get("/ximalaya/download")
async def download_ximalaya(
    audio_id: str,
    _: None = Depends(require_ximalaya)  # ä½¿ç”¨é¢„å®šä¹‰çš„ä¾èµ–
):
    """
    å–œé©¬æ‹‰é›…ä¸‹è½½æ¥å£
    """
    file_url = download_audio(audio_id)
    return {"file_url": file_url}


# åˆ›å»ºè‡ªå®šä¹‰æƒé™ä¾èµ–
require_douyin = create_permission_dependency("douyin")

@router.get("/douyin/video")
async def get_douyin_video(
    video_id: str,
    _: None = Depends(require_douyin)  # ä½¿ç”¨è‡ªå®šä¹‰ä¾èµ–
):
    """
    æŠ–éŸ³è§†é¢‘æ¥å£
    """
    video_url = get_video_url(video_id)
    return {"video_url": video_url}
```

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¾®ä¿¡å…¬ä¼—å·çˆ¬è™«æ¨¡å—

```python
# app/api/endpoints/wechat.py

from fastapi import APIRouter, Depends, Query
from typing import List, Optional

from app.decorators.permission_decorator import require_wechat

router = APIRouter(prefix="/wechat", tags=["å¾®ä¿¡å…¬ä¼—å·"])


@router.get("/search")
async def search_articles(
    keyword: str = Query(..., description="æœç´¢å…³é”®è¯"),
    page: int = Query(1, ge=1, description="é¡µç "),
    _: None = Depends(require_wechat)
):
    """
    æœç´¢å¾®ä¿¡å…¬ä¼—å·æ–‡ç« 
    
    éœ€è¦æƒé™ï¼šwechat
    """
    # æ¨¡æ‹Ÿæœç´¢é€»è¾‘
    articles = [
        {"title": f"æ–‡ç«  {i}", "url": f"http://example.com/{i}"}
        for i in range(1, 11)
    ]
    
    return {
        "keyword": keyword,
        "page": page,
        "total": 100,
        "articles": articles
    }


@router.get("/article/{article_id}")
async def get_article_detail(
    article_id: str,
    _: None = Depends(require_wechat)
):
    """
    è·å–æ–‡ç« è¯¦æƒ…
    
    éœ€è¦æƒé™ï¼šwechat
    """
    # æ¨¡æ‹Ÿè·å–æ–‡ç« è¯¦æƒ…
    article = {
        "id": article_id,
        "title": "ç¤ºä¾‹æ–‡ç« ",
        "content": "è¿™æ˜¯æ–‡ç« å†…å®¹...",
        "author": "å…¬ä¼—å·åç§°",
        "publish_time": "2026-01-28"
    }
    
    return article


@router.post("/download")
async def download_article(
    article_id: str,
    _: None = Depends(require_wechat)
):
    """
    ä¸‹è½½æ–‡ç« 
    
    éœ€è¦æƒé™ï¼šwechat
    """
    # æ¨¡æ‹Ÿä¸‹è½½é€»è¾‘
    file_path = f"/downloads/{article_id}.html"
    
    return {
        "article_id": article_id,
        "file_path": file_path,
        "status": "success"
    }
```

### ç¤ºä¾‹ 2ï¼šå–œé©¬æ‹‰é›…éŸ³é¢‘ä¸‹è½½æ¨¡å—

```python
# app/api/endpoints/ximalaya.py

from fastapi import APIRouter, Depends, Query
from typing import List

from app.decorators.permission_decorator import require_ximalaya

router = APIRouter(prefix="/ximalaya", tags=["å–œé©¬æ‹‰é›…"])


@router.get("/search")
async def search_audio(
    keyword: str = Query(..., description="æœç´¢å…³é”®è¯"),
    _: None = Depends(require_ximalaya)
):
    """
    æœç´¢éŸ³é¢‘
    
    éœ€è¦æƒé™ï¼šximalaya
    """
    audios = [
        {
            "id": f"audio_{i}",
            "title": f"éŸ³é¢‘ {i}",
            "duration": 3600,
            "æ’­æ”¾é‡": 10000
        }
        for i in range(1, 11)
    ]
    
    return {"keyword": keyword, "audios": audios}


@router.post("/download")
async def download_audio(
    audio_id: str,
    quality: str = Query("high", description="éŸ³è´¨ï¼šlow/mid/high"),
    _: None = Depends(require_ximalaya)
):
    """
    ä¸‹è½½éŸ³é¢‘
    
    éœ€è¦æƒé™ï¼šximalaya
    """
    download_url = f"http://cdn.example.com/{audio_id}_{quality}.mp3"
    
    return {
        "audio_id": audio_id,
        "quality": quality,
        "download_url": download_url,
        "status": "success"
    }
```

### ç¤ºä¾‹ 3ï¼šç»„åˆå¤šä¸ªä¾èµ–

```python
from fastapi import APIRouter, Depends
from app.decorators.permission_decorator import require_wechat
from app.api.dependencies import get_current_user

router = APIRouter()


@router.get("/wx/user-search")
async def user_specific_search(
    query: str,
    current_user: dict = Depends(get_current_user),  # éœ€è¦ç™»å½•
    _: None = Depends(require_wechat)  # éœ€è¦ wechat æƒé™
):
    """
    ç”¨æˆ·ä¸“å±æœç´¢
    
    åŒæ—¶éœ€è¦ï¼š
    1. ç™»å½•ï¼ˆget_current_userï¼‰
    2. wechat æƒé™ï¼ˆrequire_wechatï¼‰
    """
    username = current_user["username"]
    
    # æ ¹æ®ç”¨æˆ·åå¥½æœç´¢
    results = personalized_search(username, query)
    
    return {
        "user": username,
        "query": query,
        "results": results
    }
```

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æ–¹å¼

**ä½¿ç”¨è£…é¥°å™¨ `@require_permission`**ï¼š
- âœ… å½“ä½ éœ€è¦åœ¨å‡½æ•°å†…è®¿é—® `current_user` å’Œ `db`
- âœ… å½“ä½ éœ€è¦æ›´çµæ´»çš„æ§åˆ¶

**ä½¿ç”¨ä¾èµ–æ³¨å…¥ `Depends(require_xxx)`**ï¼š
- âœ… æ›´ç¬¦åˆ FastAPI è®¾è®¡ç†å¿µï¼ˆæ¨èï¼‰
- âœ… ä»£ç æ›´ç®€æ´
- âœ… å¯ä»¥ä¸å…¶ä»–ä¾èµ–ç»„åˆ

### 2. é¢„å®šä¹‰å¸¸ç”¨æƒé™

```python
# app/decorators/permission_decorator.py

# ä¸ºæ¯ä¸ªæƒé™åˆ›å»ºä¸€ä¸ªä¾èµ–
require_wechat = create_permission_dependency("wechat")
require_ximalaya = create_permission_dependency("ximalaya")
require_douyin = create_permission_dependency("douyin")
require_kuaishou = create_permission_dependency("kuaishou")

# åœ¨å…¶ä»–æ–‡ä»¶ä¸­ä½¿ç”¨
from app.decorators.permission_decorator import require_wechat

@router.get("/wx/xxx")
async def xxx(_: None = Depends(require_wechat)):
    pass
```

### 3. ç»Ÿä¸€é”™è¯¯å¤„ç†

æƒé™éªŒè¯å¤±è´¥ä¼šè‡ªåŠ¨æŠ›å‡º `HTTPException(403)`ï¼Œå‰ç«¯ç»Ÿä¸€å¤„ç†ï¼š

```javascript
// å‰ç«¯ä¼ªä»£ç 
fetch('/api/v1/wx/search', {
    headers: {'Authorization': `Bearer ${token}`}
})
.then(response => {
    if (response.status === 403) {
        // æ²¡æœ‰æƒé™
        alert('æ‚¨æ²¡æœ‰æ­¤åŠŸèƒ½çš„æƒé™ï¼Œè¯·è´­ä¹°ç›¸åº”çš„å¥—é¤');
    } else {
        // æ­£å¸¸å¤„ç†
        return response.json();
    }
})
```

### 4. æ‰¹é‡æ£€æŸ¥æƒé™ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰

```python
# å®¢æˆ·ç«¯åº”ç”¨å¯åŠ¨æ—¶
def check_app_permissions():
    """æ£€æŸ¥åº”ç”¨éœ€è¦çš„æ‰€æœ‰æƒé™"""
    response = requests.post(
        "http://localhost:8003/api/v1/permission/batch-check",
        headers={"Authorization": f"Bearer {token}"},
        json={
            "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
        }
    )
    
    results = response.json()["results"]
    
    # æ ¹æ®æƒé™ç»“æœæ˜¾ç¤º/éšè—åŠŸèƒ½
    if results["wechat"]:
        show_wechat_module()
    else:
        hide_wechat_module()
    
    if results["ximalaya"]:
        show_ximalaya_module()
    else:
        hide_ximalaya_module()
```

### 5. å®æ—¶æ£€æŸ¥ï¼ˆä¸šåŠ¡æ“ä½œæ—¶ï¼‰

```python
# ç”¨æˆ·ç‚¹å‡»åŠŸèƒ½æŒ‰é’®æ—¶
def on_wechat_search_button_clicked():
    """ç”¨æˆ·ç‚¹å‡»å¾®ä¿¡æœç´¢æŒ‰é’®"""
    # å†æ¬¡ç¡®è®¤æƒé™ï¼ˆé˜²æ­¢å¡å¯†è¿‡æœŸï¼‰
    response = requests.post(
        "http://localhost:8003/api/v1/permission/check",
        headers={"Authorization": f"Bearer {token}"},
        json={"permission": "wechat"}
    )
    
    if response.json()["allowed"]:
        # æ‰§è¡Œæœç´¢
        perform_search()
    else:
        # æç¤ºç”¨æˆ·
        message = response.json()["message"]
        show_error(f"æ— æ³•æ‰§è¡Œæ“ä½œ: {message}")
```

---

## å¸¸è§é—®é¢˜

### Q1: è£…é¥°å™¨å’Œä¾èµ–æ³¨å…¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A**: åŠŸèƒ½ç›¸åŒï¼Œåªæ˜¯å†™æ³•ä¸åŒï¼š
- è£…é¥°å™¨ï¼š`@require_permission("wechat")`
- ä¾èµ–æ³¨å…¥ï¼š`Depends(require_wechat)`

æ¨èä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæ›´ç¬¦åˆ FastAPI é£æ ¼ã€‚

### Q2: å¦‚ä½•å¤„ç†å¤šä¸ªæƒé™çš„åœºæ™¯ï¼Ÿ
**A**: å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ä¾èµ–ï¼š

```python
def require_multiple_permissions(permissions: List[str]):
    async def checker(
        current_user: dict = Depends(get_current_user),
        db: Session = Depends(get_db)
    ):
        for permission in permissions:
            # æ£€æŸ¥æ¯ä¸ªæƒé™
            pass
    return checker

# ä½¿ç”¨
@router.get("/xxx")
async def xxx(_: None = Depends(require_multiple_permissions(["wechat", "ximalaya"]))):
    pass
```

### Q3: æƒé™éªŒè¯å¤±è´¥æ—¶å¦‚ä½•è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯ï¼Ÿ
**A**: å¯ä»¥åœ¨è·¯ç”±å‡½æ•°ä¸­ä½¿ç”¨ try-exceptï¼š

```python
from fastapi import HTTPException

@router.get("/xxx")
async def xxx():
    # æ‰‹åŠ¨è°ƒç”¨æƒé™æ£€æŸ¥
    permission_service = PermissionService(db)
    allowed, message, _ = permission_service.check_permission(...)
    
    if not allowed:
        raise HTTPException(
            status_code=403,
            detail=f"è‡ªå®šä¹‰é”™è¯¯: {message}"
        )
```

### Q4: device_id ä»å“ªé‡Œæ¥ï¼Ÿ
**A**: æœ‰ä¸¤ç§æ–¹å¼ï¼š
1. ä½¿ç”¨ç™»å½•æ—¶çš„ device_idï¼ˆè‡ªåŠ¨è·å–ï¼‰
2. åœ¨è¯·æ±‚ä¸­æ˜¾å¼ä¼ é€’ device_id

æ¨èä½¿ç”¨ç¬¬ä¸€ç§ï¼Œæ›´ç®€å•ã€‚

---

## æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```python
# tests/test_permission.py

def test_check_permission_success():
    """æµ‹è¯•æƒé™éªŒè¯æˆåŠŸ"""
    # å‡†å¤‡æ•°æ®
    # è°ƒç”¨æ¥å£
    # æ–­è¨€ç»“æœ
    pass

def test_check_permission_expired():
    """æµ‹è¯•å¡å¯†è¿‡æœŸ"""
    pass

def test_check_permission_no_card():
    """æµ‹è¯•æœªç»‘å®šå¡å¯†"""
    pass
```

### 2. é›†æˆæµ‹è¯•

```python
def test_full_flow():
    """æµ‹è¯•å®Œæ•´æµç¨‹"""
    # 1. ç™»å½•
    # 2. ç»‘å®šå¡å¯†
    # 3. æ£€æŸ¥æƒé™ï¼ˆåº”è¯¥é€šè¿‡ï¼‰
    # 4. è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼ˆåº”è¯¥æˆåŠŸï¼‰
    # 5. è§£ç»‘è®¾å¤‡
    # 6. æ£€æŸ¥æƒé™ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    pass
```

---

## æ€»ç»“

æƒé™æ ¡éªŒç³»ç»Ÿæä¾›äº†çµæ´»çš„ä½¿ç”¨æ–¹å¼ï¼š

1. **å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨** - é€‚åˆæ¡Œé¢åº”ç”¨ã€ç§»åŠ¨åº”ç”¨
2. **è£…é¥°å™¨** - é€‚åˆéœ€è¦è®¿é—®ä¸Šä¸‹æ–‡çš„åœºæ™¯
3. **ä¾èµ–æ³¨å…¥** - æœ€æ¨èï¼Œç¬¦åˆ FastAPI é£æ ¼

æ ¹æ®ä½ çš„å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹å¼å³å¯ã€‚

---

**æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ**ï¼š
- é˜¶æ®µå››å®Œæˆæ€»ç»“ï¼š`app/docs/é˜¶æ®µå››å®Œæˆæ€»ç»“.md`
- API æ¥å£é€ŸæŸ¥è¡¨ï¼š`app/docs/APIæ¥å£é€ŸæŸ¥è¡¨.md`
- Swagger UIï¼šhttp://localhost:8003/docs
