# é˜¶æ®µå››æµ‹è¯• - é—®é¢˜ä¿®å¤è®°å½•

## ğŸ“… ä¿®å¤æ—¥æœŸ
2026-01-29

---

## ğŸ› é—®é¢˜ï¼šæŸ¥è¯¢æˆ‘çš„æƒé™è¿”å›ç©ºåˆ—è¡¨

### é—®é¢˜ç°è±¡
è°ƒç”¨ `GET /api/v1/permission/my-permissions` æ¥å£æ—¶ï¼Œè™½ç„¶å·²ç»‘å®šå¡å¯†ï¼Œä½†è¿”å›çš„æƒé™åˆ—è¡¨ä¸ºç©ºï¼š

```json
{
  "has_permission": false,
  "permissions": [],
  "expire_time": null
}
```

**æ—¥å¿—æ˜¾ç¤º**ï¼š
```
è·å–ç”¨æˆ·æƒé™: user_id=3, device_id=device-001, permissions=[], expire_time=None
```

### æ ¹æœ¬åŸå› åˆ†æ

å¯èƒ½çš„åŸå› ï¼š
1. **JSON ç±»å‹å¤„ç†é—®é¢˜**ï¼šMySQL çš„ JSON å­—æ®µåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½è¢« SQLAlchemy è¯»å–ä¸ºå­—ç¬¦ä¸²
2. **æƒé™é…ç½®æ ¼å¼**ï¼šæ•°æ®åº“ä¸­çš„ permissions å¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²è€Œä¸æ˜¯è§£æåçš„ Python å¯¹è±¡

### è§£å†³æ–¹æ¡ˆ

#### ä¿®å¤ 1ï¼šæ·»åŠ å­—ç¬¦ä¸²ç±»å‹å¤„ç†

åœ¨ `app/services/permission_service.py` ä¸­æ·»åŠ å¯¹ JSON å­—ç¬¦ä¸²çš„è§£æï¼š

**check_permission() æ–¹æ³•**ï¼š
```python
# å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸º JSON
if isinstance(card_permissions, str):
    import json
    try:
        card_permissions = json.loads(card_permissions)
        logger.debug(f"è§£æJSONå­—ç¬¦ä¸²: card_id={card.id}, permissions={card_permissions}")
    except json.JSONDecodeError:
        logger.error(f"æ— æ³•è§£æå¡å¯†æƒé™é…ç½®: {card_permissions}")
        continue
```

**get_user_permissions() æ–¹æ³•**ï¼š
```python
elif isinstance(card.permissions, str):
    # å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸º JSON
    import json
    try:
        parsed = json.loads(card.permissions)
        if isinstance(parsed, list):
            all_permissions.update(parsed)
        elif isinstance(parsed, dict):
            for perm, value in parsed.items():
                if value is True or value == "true":
                    all_permissions.add(perm)
    except json.JSONDecodeError:
        logger.error(f"æ— æ³•è§£æå¡å¯†æƒé™é…ç½®: {card.permissions}")
```

#### ä¿®å¤ 2ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ä»¥ä¾¿æ’æŸ¥é—®é¢˜ï¼š

```python
logger.debug(
    f"å¡å¯†æƒé™é…ç½®: card_id={card.id}, "
    f"permissions={card.permissions}, "
    f"type={type(card.permissions)}"
)
```

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### 1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…æ•°æ®

è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š
```bash
mysql -u root -p login_km_system_dev < app/scripts/check_card_permissions.sql
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- cards è¡¨çš„ç»“æ„
- permissions åˆ—çš„æ•°æ®ç±»å‹
- å®é™…çš„å¡å¯†æ•°æ®
- ç”¨æˆ·ç»‘å®šçš„å¡å¯†
- è®¾å¤‡ç»‘å®šæƒ…å†µ

### 2. æŸ¥çœ‹æƒé™ç±»å‹

åœ¨ MySQL ä¸­æ‰§è¡Œï¼š
```sql
-- æŸ¥çœ‹ permissions çš„ç±»å‹
SELECT 
    id,
    card_key,
    permissions,
    JSON_TYPE(permissions) as json_type
FROM cards
WHERE card_key = 'A3KD-Q7LM-P2E8-W9RZ';
```

**é¢„æœŸç»“æœ**ï¼š
- `json_type` åº”è¯¥æ˜¯ `ARRAY`

### 3. æµ‹è¯•æƒé™æ ¡éªŒ

å¯åŠ¨æœåŠ¡åï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­çš„è°ƒè¯•ä¿¡æ¯ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/app.log | grep "å¡å¯†æƒé™é…ç½®"
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### ä»£ç æ–‡ä»¶
1. `app/services/permission_service.py` - æ·»åŠ å­—ç¬¦ä¸²ç±»å‹å¤„ç†å’Œè°ƒè¯•æ—¥å¿—

### æ–°å¢æ–‡ä»¶
1. `app/scripts/check_card_permissions.sql` - è¯Šæ–­è„šæœ¬
2. `app/docs/é—®é¢˜ä¿®å¤è®°å½•_é˜¶æ®µå››æµ‹è¯•.md` - æœ¬æ–‡æ¡£

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1ï¼šé‡å¯åº”ç”¨
```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
python run_app.py
```

### æ­¥éª¤ 2ï¼šé‡æ–°æµ‹è¯•

```bash
# 1. ç™»å½•
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-001"
  }'

# 2. æŸ¥è¯¢æƒé™ï¼ˆåº”è¯¥çœ‹åˆ° wechat å’Œ ximalayaï¼‰
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸç»“æœ**ï¼š
```json
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹æ—¥å¿—

æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰è°ƒè¯•ä¿¡æ¯ï¼š
```
å¡å¯†æƒé™é…ç½®: card_id=1, permissions=['wechat', 'ximalaya'], type=<class 'list'>
```

æˆ–è€…ï¼š
```
å¡å¯†æƒé™é…ç½®: card_id=1, permissions=["wechat", "ximalaya"], type=<class 'str'>
è§£æJSONå­—ç¬¦ä¸²: card_id=1, permissions=['wechat', 'ximalaya']
```

---

## ğŸ”§ é¢å¤–çš„ä¿®å¤å»ºè®®

### å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

#### æ–¹æ¡ˆ 1ï¼šä¿®å¤æ•°æ®åº“æ•°æ®

å¦‚æœæ•°æ®åº“ä¸­ permissions æ˜¯çº¯æ–‡æœ¬è€Œä¸æ˜¯ JSON ç±»å‹ï¼š

```sql
-- æ›´æ–°æ‰€æœ‰å¡å¯†çš„ permissions ä¸ºæ­£ç¡®çš„ JSON æ ¼å¼
UPDATE cards 
SET permissions = CAST(permissions AS JSON)
WHERE permissions IS NOT NULL;
```

#### æ–¹æ¡ˆ 2ï¼šé‡æ–°æ’å…¥æµ‹è¯•æ•°æ®

```bash
# åˆ é™¤ç°æœ‰æµ‹è¯•å¡å¯†
mysql -u root -p login_km_system_dev -e "DELETE FROM cards WHERE app_id = 1;"

# é‡æ–°æ’å…¥
mysql -u root -p login_km_system_dev < app/scripts/insert_test_cards.sql
```

#### æ–¹æ¡ˆ 3ï¼šæ‰‹åŠ¨æ’å…¥ JSON æ•°æ®

```sql
-- ä½¿ç”¨ JSON_ARRAY å‡½æ•°æ’å…¥
INSERT INTO cards (app_id, card_key, status, expire_time, max_device_count, permissions, remark)
VALUES 
(1, 'TEST-TEST-TEST-TEST', 'unused', '2026-12-31 23:59:59', 2, 
 JSON_ARRAY('wechat', 'ximalaya'), 
 'æµ‹è¯•å¡å¯†-JSONæ’å…¥');
```

---

## ğŸ“Š å…¼å®¹æ€§è¯´æ˜

### MySQL JSON ç±»å‹æ”¯æŒ

- **MySQL 5.7+**: åŸç”Ÿæ”¯æŒ JSON ç±»å‹
- **MySQL 5.6 åŠä»¥ä¸‹**: ä¸æ”¯æŒ JSON ç±»å‹ï¼Œä½¿ç”¨ TEXT

### SQLAlchemy JSON å¤„ç†

- **è‡ªåŠ¨åºåˆ—åŒ–**: SQLAlchemy ä¼šè‡ªåŠ¨å°† Python å¯¹è±¡åºåˆ—åŒ–ä¸º JSON
- **è‡ªåŠ¨ååºåˆ—åŒ–**: ä»æ•°æ®åº“è¯»å–æ—¶è‡ªåŠ¨è½¬æ¢ä¸º Python å¯¹è±¡
- **å­—ç¬¦ä¸²å…¼å®¹**: å¦‚æœè¯»å–åˆ°å­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰‹åŠ¨è§£æ

---

## âœ… é¢„æœŸä¿®å¤æ•ˆæœ

ä¿®å¤åï¼š
1. âœ… æŸ¥è¯¢æˆ‘çš„æƒé™è¿”å›æ­£ç¡®çš„æƒé™åˆ—è¡¨
2. âœ… æƒé™æ ¡éªŒæ­£å¸¸å·¥ä½œ
3. âœ… æ”¯æŒ JSON å­—ç¬¦ä¸²ã€list å’Œ dict ä¸‰ç§æ ¼å¼
4. âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å¸®åŠ©æ’æŸ¥é—®é¢˜

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ•°æ®åº“ JSON ç±»å‹çš„å¤„ç†
- ä¸åŒæ•°æ®åº“å¯¹ JSON çš„æ”¯æŒä¸åŒ
- SQLAlchemy çš„ JSON ç±»å‹åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½è¿”å›å­—ç¬¦ä¸²
- ä»£ç ä¸­åº”è¯¥åŒæ—¶å¤„ç†å¯¹è±¡å’Œå­—ç¬¦ä¸²ä¸¤ç§æƒ…å†µ

### 2. è°ƒè¯•æ—¥å¿—çš„é‡è¦æ€§
- æ·»åŠ ç±»å‹ä¿¡æ¯çš„æ—¥å¿—éå¸¸æœ‰åŠ©äºæ’æŸ¥é—®é¢˜
- æ—¥å¿—åº”è¯¥åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

### 3. å‘åå…¼å®¹
- ä»£ç åº”è¯¥èƒ½å¤Ÿå¤„ç†å¤šç§æ•°æ®æ ¼å¼
- ä¼˜é›…é™çº§ï¼Œå³ä½¿æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸä¹Ÿèƒ½ç»™å‡ºæ˜ç¡®çš„é”™è¯¯æç¤º

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

å®Œæˆä¿®å¤åï¼Œè¯·éªŒè¯ï¼š

- [ ] é‡å¯åº”ç”¨æœåŠ¡
- [ ] è¿è¡Œè¯Šæ–­è„šæœ¬æ£€æŸ¥æ•°æ®
- [ ] æµ‹è¯•æŸ¥è¯¢æˆ‘çš„æƒé™æ¥å£
- [ ] æµ‹è¯•æƒé™æ ¡éªŒæ¥å£
- [ ] æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æƒé™ç±»å‹
- [ ] ç¡®è®¤æ‰€æœ‰æƒé™åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

**é—®é¢˜ä¿®å¤å®Œæˆï¼** âœ…

å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æˆ–è¿è¡Œè¯Šæ–­è„šæœ¬è¿›ä¸€æ­¥æ’æŸ¥ã€‚
