# å¿«é€Ÿä¿®å¤æŒ‡å— - æƒé™æŸ¥è¯¢è¿”å›ç©ºåˆ—è¡¨

## ğŸš¨ é—®é¢˜æè¿°

è°ƒç”¨ `GET /api/v1/permission/my-permissions` è¿”å›ç©ºåˆ—è¡¨ï¼Œå³ä½¿å·²ç»ç»‘å®šäº†å¡å¯†ã€‚

---

## âš¡ å¿«é€Ÿä¿®å¤æ­¥éª¤

### 1. é‡å¯åº”ç”¨æœåŠ¡

ä»£ç å·²ç»æ›´æ–°ï¼Œéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼š

```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+C æˆ– kill è¿›ç¨‹ï¼‰

# é‡æ–°å¯åŠ¨
python run_app.py
```

### 2. è¿è¡Œè¯Šæ–­è„šæœ¬

æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…æ•°æ®ï¼š

```bash
python app/scripts/test_json_permissions.py
```

**æŸ¥çœ‹è¾“å‡º**ï¼š
- âœ… å¦‚æœçœ‹åˆ° "Permissions æ˜¯åˆ—è¡¨"ï¼Œè¯´æ˜æ•°æ®æ­£å¸¸
- âš ï¸ å¦‚æœçœ‹åˆ° "Permissions æ˜¯å­—ç¬¦ä¸²"ï¼Œè¯´æ˜éœ€è¦è§£æï¼ˆä»£ç å·²å¤„ç†ï¼‰
- âŒ å¦‚æœçœ‹åˆ° "Permissions ä¸º None"ï¼Œè¯´æ˜æ•°æ®ç¼ºå¤±

### 3. é‡æ–°æµ‹è¯•

```bash
# æµ‹è¯•æŸ¥è¯¢æƒé™
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸç»“æœ**ï¼š
```json
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

---

## ğŸ” å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### æ–¹æ¡ˆ Aï¼šæ£€æŸ¥æ˜¯å¦çœŸçš„ç»‘å®šäº†å¡å¯†

```bash
# æŸ¥è¯¢æˆ‘çš„å¡å¯†
curl -X GET "http://localhost:8003/api/v1/card/my" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**å¦‚æœè¿”å›ç©ºåˆ—è¡¨**ï¼Œè¯´æ˜æ²¡æœ‰ç»‘å®šå¡å¯†ï¼Œéœ€è¦å…ˆç»‘å®šï¼š

```bash
curl -X POST "http://localhost:8003/api/v1/card/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_key": "A3KD-Q7LM-P2E8-W9RZ",
    "device_id": "device-001",
    "device_name": "æµ‹è¯•è®¾å¤‡"
  }'
```

### æ–¹æ¡ˆ Bï¼šæ£€æŸ¥è®¾å¤‡IDæ˜¯å¦åŒ¹é…

ç¡®ä¿æŸ¥è¯¢æƒé™æ—¶ä½¿ç”¨çš„ device_id ä¸ç»‘å®šå¡å¯†æ—¶ä½¿ç”¨çš„ç›¸åŒï¼š

```bash
# æ˜ç¡®æŒ‡å®š device_id
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions?device_id=device-001" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### æ–¹æ¡ˆ Cï¼šæŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—
tail -f logs/app.log

# æˆ–è€…æŸ¥çœ‹å®Œæ•´æ—¥å¿—
cat logs/app.log | grep "è·å–ç”¨æˆ·æƒé™"
```

**æŸ¥æ‰¾å…³é”®ä¿¡æ¯**ï¼š
- "å¡å¯†æƒé™é…ç½®" - æŸ¥çœ‹ permissions çš„ç±»å‹
- "è·å–ç”¨æˆ·æƒé™" - æŸ¥çœ‹æœ€ç»ˆè¿”å›çš„æƒé™åˆ—è¡¨

---

## ğŸ“Š è¯Šæ–­ç»“æœè¯´æ˜

### æƒ…å†µ 1ï¼šPermissions æ˜¯å­—ç¬¦ä¸²

```
å¡å¯†æƒé™é…ç½®: card_id=1, permissions=["wechat", "ximalaya"], type=<class 'str'>
è§£æJSONå­—ç¬¦ä¸²: card_id=1, permissions=['wechat', 'ximalaya']
```

**è¯´æ˜**ï¼šMySQLè¿”å›çš„æ˜¯JSONå­—ç¬¦ä¸²ï¼Œä½†ä»£ç å·²ç»è‡ªåŠ¨è§£æã€‚

**ç»“æœ**ï¼šâœ… åº”è¯¥æ­£å¸¸å·¥ä½œ

### æƒ…å†µ 2ï¼šPermissions æ˜¯åˆ—è¡¨

```
å¡å¯†æƒé™é…ç½®: card_id=1, permissions=['wechat', 'ximalaya'], type=<class 'list'>
```

**è¯´æ˜**ï¼šMySQLè¿”å›çš„æ˜¯Pythonåˆ—è¡¨å¯¹è±¡ã€‚

**ç»“æœ**ï¼šâœ… æ­£å¸¸å·¥ä½œ

### æƒ…å†µ 3ï¼šPermissions ä¸º None

```
å¡å¯†æ²¡æœ‰æƒé™é…ç½®: card_id=1
```

**è¯´æ˜**ï¼šæ•°æ®åº“ä¸­è¯¥å¡å¯†çš„ permissions å­—æ®µä¸ºç©ºã€‚

**ç»“æœ**ï¼šâŒ éœ€è¦æ›´æ–°æ•°æ®

**ä¿®å¤**ï¼š
```sql
UPDATE cards 
SET permissions = '["wechat", "ximalaya"]'
WHERE id = 1;
```

---

## ğŸ› ï¸ å®Œæ•´çš„æ•°æ®ä¿®å¤

å¦‚æœæ•°æ®æœ‰é—®é¢˜ï¼Œå¯ä»¥é‡æ–°æ’å…¥æµ‹è¯•æ•°æ®ï¼š

```bash
# 1. åˆ é™¤ç°æœ‰æµ‹è¯•å¡å¯†
mysql -u root -p login_km_system_dev -e "DELETE FROM cards WHERE remark LIKE 'æµ‹è¯•å¡å¯†%';"

# 2. é‡æ–°æ’å…¥
mysql -u root -p login_km_system_dev < app/scripts/insert_test_cards.sql

# 3. éªŒè¯æ•°æ®
python app/scripts/test_json_permissions.py
```

---

## âœ… éªŒè¯ä¿®å¤æˆåŠŸ

ä¾æ¬¡æµ‹è¯•ä»¥ä¸‹æ¥å£ï¼š

### 1. æŸ¥è¯¢æˆ‘çš„å¡å¯†
```bash
curl -X GET "http://localhost:8003/api/v1/card/my" \
  -H "Authorization: Bearer YOUR_TOKEN"
```
**é¢„æœŸ**ï¼šè¿”å›å·²ç»‘å®šçš„å¡å¯†åˆ—è¡¨

### 2. æŸ¥è¯¢æˆ‘çš„æƒé™
```bash
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```
**é¢„æœŸ**ï¼šè¿”å›æƒé™åˆ—è¡¨ `["wechat", "ximalaya"]`

### 3. æ ¡éªŒå•ä¸ªæƒé™
```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"permission": "wechat"}'
```
**é¢„æœŸ**ï¼š`"allowed": true`

### 4. æ‰¹é‡æ ¡éªŒæƒé™
```bash
curl -X POST "http://localhost:8003/api/v1/permission/batch-check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"permissions": ["wechat", "ximalaya", "douyin"]}'
```
**é¢„æœŸ**ï¼š
```json
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false
  }
}
```

---

## ğŸ“ ä»æœ‰é—®é¢˜ï¼Ÿ

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·ï¼š

1. **æ”¶é›†ä¿¡æ¯**ï¼š
   - è¿è¡Œ `python app/scripts/test_json_permissions.py` çš„å®Œæ•´è¾“å‡º
   - æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶ `logs/app.log`
   - ä½¿ç”¨çš„æµ‹è¯•å‘½ä»¤

2. **æ£€æŸ¥ç¯å¢ƒ**ï¼š
   - MySQL ç‰ˆæœ¬ï¼š`mysql --version`
   - Python ç‰ˆæœ¬ï¼š`python --version`
   - SQLAlchemy ç‰ˆæœ¬ï¼š`pip show sqlalchemy`

3. **æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£**ï¼š
   - `app/docs/é—®é¢˜ä¿®å¤è®°å½•_é˜¶æ®µå››æµ‹è¯•.md`
   - `app/docs/é˜¶æ®µå››æµ‹è¯•æŒ‡å—.md`

---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **å·²ä¿®å¤çš„é—®é¢˜**ï¼š
   - âœ… ä»£ç ç°åœ¨æ”¯æŒå­—ç¬¦ä¸²ç±»å‹çš„JSON
   - âœ… æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
   - âœ… åŒæ—¶æ”¯æŒ listã€dict å’Œ str ä¸‰ç§æ ¼å¼

2. **é‡å¯æ˜¯å¿…é¡»çš„**ï¼š
   - âš ï¸ ä»£ç æ›´æ–°åå¿…é¡»é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆ

3. **è®¾å¤‡IDè¦åŒ¹é…**ï¼š
   - âš ï¸ æŸ¥è¯¢æƒé™çš„device_idå¿…é¡»ä¸ç»‘å®šæ—¶çš„ç›¸åŒ

4. **å…ˆç»‘å®šå¡å¯†**ï¼š
   - âš ï¸ å¿…é¡»å…ˆç»‘å®šå¡å¯†æ‰æœ‰æƒé™

---

**ç¥ä¿®å¤é¡ºåˆ©ï¼** âœ…
