# é˜¶æ®µå››ï¼šæƒé™æ ¡éªŒç³»ç»Ÿ - å®Œæˆæ€»ç»“

## âœ… å®Œæˆæ—¶é—´
2026-01-28

---

## âœ… å®Œæˆçš„ä»»åŠ¡

### ä»»åŠ¡ 11ï¼šå®ç°æƒé™æ ¡éªŒæœåŠ¡å±‚ âœ…

**æ–‡ä»¶**: `app/services/permission_service.py`

#### å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

**11.1 å•ä¸ªæƒé™æ ¡éªŒ** - `check_permission()`

å®Œæ•´çš„9æ­¥éªŒè¯æµç¨‹ï¼š
1. âœ… æŸ¥è¯¢ç”¨æˆ·çŠ¶æ€
2. âœ… éªŒè¯ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
3. âœ… æŸ¥è¯¢ç”¨æˆ·ç»‘å®šçš„å¡å¯†
4. âœ… éªŒè¯å¡å¯†çŠ¶æ€ï¼ˆæ˜¯å¦ç¦ç”¨ï¼‰
5. âœ… éªŒè¯å¡å¯†æ˜¯å¦è¿‡æœŸ
6. âœ… éªŒè¯è®¾å¤‡ç»‘å®š
7. âœ… éªŒè¯è®¾å¤‡çŠ¶æ€ï¼ˆæ˜¯å¦è¢«ç¦ç”¨ï¼‰
8. âœ… éªŒè¯æƒé™é…ç½®ï¼ˆpermission æ˜¯å¦åœ¨ permissions ä¸­ï¼‰
9. âœ… æ›´æ–°è®¾å¤‡æœ€åæ´»è·ƒæ—¶é—´

**è¿”å›å€¼**ï¼š
- `allowed`: æ˜¯å¦å…è®¸ (bool)
- `message`: æç¤ºä¿¡æ¯ (str)
- `expire_time`: å¡å¯†è¿‡æœŸæ—¶é—´ (Optional[datetime])

**11.2 æ‰¹é‡æƒé™æ ¡éªŒ** - `batch_check_permissions()`
- âœ… ä¸€æ¬¡æ€§æ£€æŸ¥å¤šä¸ªæƒé™
- âœ… è¿”å›æƒé™æ£€æŸ¥ç»“æœå­—å…¸
- âœ… æé«˜æ‰¹é‡æ£€æŸ¥æ•ˆç‡

**11.3 è·å–ç”¨æˆ·æƒé™** - `get_user_permissions()`
- âœ… è·å–ç”¨æˆ·åœ¨æŒ‡å®šè®¾å¤‡ä¸Šçš„æ‰€æœ‰æƒé™
- âœ… è¿”å›æƒé™åˆ—è¡¨å’Œè¿‡æœŸæ—¶é—´
- âœ… æ”¯æŒ list å’Œ dict ä¸¤ç§æƒé™é…ç½®æ ¼å¼

---

### ä»»åŠ¡ 12ï¼šå®ç°æƒé™æ ¡éªŒ API æ¥å£ âœ…

**æ–‡ä»¶**: `app/api/endpoints/permission.py`

#### å®ç°çš„æ¥å£

**12.1 æƒé™æ ¡éªŒ**
```http
POST /api/v1/permission/check
Authorization: Bearer <token>
Content-Type: application/json

{
  "permission": "wechat",
  "device_id": "device-001"  // å¯é€‰
}
```

**å“åº”ç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰**ï¼š
```json
{
  "allowed": true,
  "message": "æƒé™éªŒè¯é€šè¿‡",
  "expire_time": "2026-12-31T23:59:59"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆå¤±è´¥ï¼‰**ï¼š
```json
{
  "allowed": false,
  "message": "å¡å¯†å·²è¿‡æœŸ",
  "expire_time": null
}
```

**12.2 æ‰¹é‡æƒé™æ ¡éªŒ**
```http
POST /api/v1/permission/batch-check
Authorization: Bearer <token>
Content-Type: application/json

{
  "permissions": ["wechat", "ximalaya", "douyin"],
  "device_id": "device-001"  // å¯é€‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false
  }
}
```

**12.3 æŸ¥è¯¢æˆ‘çš„æƒé™**
```http
GET /api/v1/permission/my-permissions?device_id=device-001
Authorization: Bearer <token>
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

---

### ä»»åŠ¡ 13ï¼šåˆ›å»ºæƒé™æ ¡éªŒè£…é¥°å™¨/ä¾èµ– âœ…

**æ–‡ä»¶**: `app/decorators/permission_decorator.py`

#### å®ç°çš„åŠŸèƒ½

**13.1 è£…é¥°å™¨ç‰ˆæœ¬** - `@require_permission(permission)`

ä½¿ç”¨æ–¹å¼ï¼š
```python
from app.decorators import require_permission
from app.utils.dependencies import get_current_user
from fastapi import Depends

@router.get("/wx/search")
@require_permission("wechat")
async def search_wechat(
    query: str,
    current_user: dict = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æƒé™éªŒè¯å·²é€šè¿‡
    return {"result": "æœç´¢ç»“æœ"}
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ä» current_user è·å– user_id å’Œ device_id
- âœ… æƒé™éªŒè¯å¤±è´¥è‡ªåŠ¨æŠ›å‡º 403 HTTPException
- âœ… è®°å½•è¯¦ç»†çš„æ—¥å¿—

**13.2 ä¾èµ–æ³¨å…¥ç‰ˆæœ¬** - `create_permission_dependency(permission)`

ä½¿ç”¨æ–¹å¼ï¼š
```python
from app.decorators.permission_decorator import create_permission_dependency

# åˆ›å»ºæƒé™ä¾èµ–
require_wechat = create_permission_dependency("wechat")

@router.get("/wx/search")
async def search_wechat(
    query: str,
    _: None = Depends(require_wechat)
):
    # å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æƒé™éªŒè¯å·²é€šè¿‡
    return {"result": "æœç´¢ç»“æœ"}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ›´ç¬¦åˆ FastAPI è®¾è®¡ç†å¿µ
- âœ… å¯ä»¥ä¸å…¶ä»– Depends ç»„åˆä½¿ç”¨
- âœ… ä»£ç æ›´æ¸…æ™°ç®€æ´

**13.3 é¢„å®šä¹‰æƒé™ä¾èµ–**

ä¸ºå¸¸ç”¨æƒé™é¢„å®šä¹‰äº†ä¾èµ–å‡½æ•°ï¼š
- âœ… `require_wechat` - å¾®ä¿¡æƒé™
- âœ… `require_ximalaya` - å–œé©¬æ‹‰é›…æƒé™
- âœ… `require_douyin` - æŠ–éŸ³æƒé™
- âœ… `require_kuaishou` - å¿«æ‰‹æƒé™

---

## ğŸ“Š å®Œæˆç»Ÿè®¡

### ä»£ç æ–‡ä»¶
- âœ… 1 ä¸ªæœåŠ¡å±‚ï¼ˆpermission_service.pyï¼‰
- âœ… 1 ä¸ªæ¥å£æ–‡ä»¶ï¼ˆpermission.pyï¼‰
- âœ… 1 ä¸ªè£…é¥°å™¨æ–‡ä»¶ï¼ˆpermission_decorator.pyï¼‰
- âœ… 1 ä¸ªåŒ…åˆå§‹åŒ–æ–‡ä»¶ï¼ˆdecorators/__init__.pyï¼‰

### æ¥å£ç»Ÿè®¡
- âœ… 3 ä¸ªæƒé™æ ¡éªŒæ¥å£
  - å•ä¸ªæƒé™æ ¡éªŒ
  - æ‰¹é‡æƒé™æ ¡éªŒ
  - æŸ¥è¯¢æˆ‘çš„æƒé™

### æœåŠ¡æ–¹æ³•
- âœ… 3 ä¸ªæ ¸å¿ƒæœåŠ¡æ–¹æ³•
  - check_permission()
  - batch_check_permissions()
  - get_user_permissions()

### è£…é¥°å™¨/ä¾èµ–
- âœ… 2 ç§ä½¿ç”¨æ–¹å¼
  - @require_permission è£…é¥°å™¨
  - create_permission_dependency ä¾èµ–æ³¨å…¥
- âœ… 4 ä¸ªé¢„å®šä¹‰æƒé™ä¾èµ–

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### æƒé™æ ¡éªŒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®¢æˆ·ç«¯è°ƒç”¨ä¸šåŠ¡åŠŸèƒ½å‰               â”‚
â”‚      POST /api/v1/permission/check         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æƒé™æ ¡éªŒæœåŠ¡å±‚                â”‚
â”‚         9æ­¥ä¸¥æ ¼éªŒè¯æµç¨‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   éªŒè¯é€šè¿‡ï¼Ÿ      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†™              â†˜
      YES               NO
       â†“                 â†“
  allowed=true     allowed=false
  è¿”å›è¿‡æœŸæ—¶é—´      è¿”å›å¤±è´¥åŸå› 
       â†“                 â†“
  æ‰§è¡Œä¸šåŠ¡é€»è¾‘     æç¤ºç”¨æˆ·æ²¡æœ‰æƒé™
```

### 9æ­¥éªŒè¯è¯¦è§£

1. **ç”¨æˆ·çŠ¶æ€æ£€æŸ¥**
   - ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - ç”¨æˆ·æ˜¯å¦è¢«å°ç¦

2. **å¡å¯†ç»‘å®šæ£€æŸ¥**
   - ç”¨æˆ·æ˜¯å¦ç»‘å®šäº†å¡å¯†
   - æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒçš„å¡å¯†

3. **å¡å¯†çŠ¶æ€æ£€æŸ¥**
   - å¡å¯†æ˜¯å¦è¢«ç¦ç”¨
   - éå†æ‰€æœ‰å¡å¯†å¯»æ‰¾æœ‰æ•ˆçš„

4. **å¡å¯†è¿‡æœŸæ£€æŸ¥**
   - æ£€æŸ¥å¡å¯†æ˜¯å¦å·²è¿‡æœŸ
   - è·³è¿‡è¿‡æœŸçš„å¡å¯†

5. **è®¾å¤‡ç»‘å®šæ£€æŸ¥**
   - è®¾å¤‡æ˜¯å¦ç»‘å®šåˆ°å¡å¯†
   - è·³è¿‡æœªç»‘å®šæ­¤è®¾å¤‡çš„å¡å¯†

6. **è®¾å¤‡çŠ¶æ€æ£€æŸ¥**
   - è®¾å¤‡æ˜¯å¦è¢«ç¦ç”¨
   - ç¦ç”¨è®¾å¤‡ç«‹å³è¿”å›å¤±è´¥

7. **æƒé™é…ç½®æ£€æŸ¥**
   - permission æ˜¯å¦åœ¨ permissions åˆ—è¡¨ä¸­
   - æ”¯æŒ list å’Œ dict ä¸¤ç§æ ¼å¼
   - dict æ ¼å¼æ£€æŸ¥ value æ˜¯å¦ä¸º true

8. **æ›´æ–°æ´»è·ƒæ—¶é—´**
   - æ›´æ–° device.last_active_at
   - è®°å½•è®¾å¤‡æœ€åä½¿ç”¨æ—¶é—´

9. **è¿”å›éªŒè¯ç»“æœ**
   - è¿”å› allowed, message, expire_time
   - è®°å½•è¯¦ç»†çš„éªŒè¯æ—¥å¿—

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### å¤šå±‚éªŒè¯
- âœ… ç”¨æˆ·çº§åˆ«ï¼šæ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- âœ… å¡å¯†çº§åˆ«ï¼šæ£€æŸ¥å¡å¯†çŠ¶æ€å’Œè¿‡æœŸæ—¶é—´
- âœ… è®¾å¤‡çº§åˆ«ï¼šæ£€æŸ¥è®¾å¤‡ç»‘å®šå’ŒçŠ¶æ€
- âœ… æƒé™çº§åˆ«ï¼šæ£€æŸ¥å…·ä½“æƒé™é…ç½®

### æ—¥å¿—è®°å½•
- âœ… éªŒè¯é€šè¿‡ï¼šINFO çº§åˆ«æ—¥å¿—
- âœ… éªŒè¯å¤±è´¥ï¼šWARNING çº§åˆ«æ—¥å¿—
- âœ… åŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆuser_id, device_id, permission, reasonï¼‰

### é”™è¯¯å¤„ç†
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… è¯¦ç»†çš„å¤±è´¥åŸå› 
- âœ… è‡ªåŠ¨æŠ›å‡ºæ ‡å‡†çš„ HTTP å¼‚å¸¸

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæƒé™æ ¡éªŒæ¥å£

```bash
# 1. ç™»å½•è·å– token
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-001"
  }'

# 2. æ ¡éªŒæƒé™
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permission": "wechat"
  }'

# å“åº”ï¼ˆæˆåŠŸï¼‰
{
  "allowed": true,
  "message": "æƒé™éªŒè¯é€šè¿‡",
  "expire_time": "2026-12-31T23:59:59"
}
```

### ç¤ºä¾‹ 2ï¼šæ‰¹é‡æƒé™æ ¡éªŒ

```bash
curl -X POST "http://localhost:8003/api/v1/permission/batch-check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin"]
  }'

# å“åº”
{
  "results": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false
  }
}
```

### ç¤ºä¾‹ 3ï¼šæŸ¥è¯¢æˆ‘çš„æƒé™

```bash
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"

# å“åº”
{
  "has_permission": true,
  "permissions": ["wechat", "ximalaya"],
  "expire_time": "2026-12-31T23:59:59"
}
```

### ç¤ºä¾‹ 4ï¼šä½¿ç”¨è£…é¥°å™¨

```python
# åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸šåŠ¡æ¥å£
from fastapi import APIRouter, Depends
from app.decorators import require_permission
from app.utils.dependencies import get_current_user

router = APIRouter()

@router.get("/wx/search")
@require_permission("wechat")
async def search_wechat(
    query: str,
    current_user: dict = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ï¼š
    # 1. ç”¨æˆ·å·²ç™»å½•
    # 2. ç”¨æˆ·æœ‰æœ‰æ•ˆçš„å¡å¯†
    # 3. å¡å¯†åŒ…å« wechat æƒé™
    # 4. è®¾å¤‡å·²ç»‘å®šä¸”çŠ¶æ€æ­£å¸¸
    
    # å®‰å…¨åœ°æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return {"result": f"æœç´¢ {query} çš„ç»“æœ"}
```

### ç¤ºä¾‹ 5ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥

```python
from fastapi import APIRouter, Depends
from app.decorators.permission_decorator import require_wechat

router = APIRouter()

@router.get("/wx/search")
async def search_wechat(
    query: str,
    _: None = Depends(require_wechat)
):
    # æ›´ç®€æ´çš„å†™æ³•
    # æƒé™éªŒè¯è‡ªåŠ¨å®Œæˆ
    return {"result": f"æœç´¢ {query} çš„ç»“æœ"}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡æµ‹è¯•æ•°æ®

ç¡®ä¿å·²ç»æ‰§è¡Œäº†æµ‹è¯•æ•°æ®è„šæœ¬ï¼š
```bash
mysql -u root -p login_km_system_dev < app/scripts/insert_test_cards.sql
```

### 2. ç»‘å®šæµ‹è¯•å¡å¯†

```bash
# ç™»å½•
curl -X POST "http://localhost:8003/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "app_key": "default_app",
    "device_id": "device-001"
  }'

# ä¿å­˜è¿”å›çš„ token

# ç»‘å®šå¡å¯†ï¼ˆåŒ…å« wechat å’Œ ximalaya æƒé™ï¼‰
curl -X POST "http://localhost:8003/api/v1/card/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "card_key": "A3KD-Q7LM-P2E8-W9RZ",
    "device_id": "device-001",
    "device_name": "æµ‹è¯•è®¾å¤‡"
  }'
```

### 3. æµ‹è¯•æƒé™æ ¡éªŒ

**æµ‹è¯• 1ï¼šéªŒè¯æ‹¥æœ‰çš„æƒé™**
```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"permission": "wechat"}'

# é¢„æœŸç»“æœï¼šallowed=true
```

**æµ‹è¯• 2ï¼šéªŒè¯æ²¡æœ‰çš„æƒé™**
```bash
curl -X POST "http://localhost:8003/api/v1/permission/check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"permission": "douyin"}'

# é¢„æœŸç»“æœï¼šallowed=false, message="æ²¡æœ‰æœ‰æ•ˆçš„å¡å¯†æˆ–æƒé™é…ç½®ä¸åŒ¹é…"
```

**æµ‹è¯• 3ï¼šæ‰¹é‡éªŒè¯æƒé™**
```bash
curl -X POST "http://localhost:8003/api/v1/permission/batch-check" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "permissions": ["wechat", "ximalaya", "douyin", "kuaishou"]
  }'

# é¢„æœŸç»“æœï¼š
# {
#   "results": {
#     "wechat": true,
#     "ximalaya": true,
#     "douyin": false,
#     "kuaishou": false
#   }
# }
```

**æµ‹è¯• 4ï¼šæŸ¥è¯¢æ‰€æœ‰æƒé™**
```bash
curl -X GET "http://localhost:8003/api/v1/permission/my-permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"

# é¢„æœŸç»“æœï¼š
# {
#   "has_permission": true,
#   "permissions": ["wechat", "ximalaya"],
#   "expire_time": "2026-12-31T23:59:59"
# }
```

---

## ğŸ” æƒé™é…ç½®æ ¼å¼è¯´æ˜

### æ ¼å¼ 1ï¼šåˆ—è¡¨æ ¼å¼ï¼ˆæ¨èï¼‰

```json
{
  "permissions": ["wechat", "ximalaya", "douyin"]
}
```

**ç‰¹ç‚¹**ï¼š
- ç®€å•ç›´è§‚
- åŒ…å«åœ¨åˆ—è¡¨ä¸­å³è¡¨ç¤ºæœ‰æƒé™
- æ¨èç”¨äºå¤§å¤šæ•°åœºæ™¯

### æ ¼å¼ 2ï¼šå­—å…¸æ ¼å¼ï¼ˆé«˜çº§ï¼‰

```json
{
  "permissions": {
    "wechat": true,
    "ximalaya": true,
    "douyin": false
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒæ›´ç»†ç²’åº¦çš„æ§åˆ¶
- å¯ä»¥æ˜¾å¼ç¦ç”¨æŸäº›æƒé™
- é€‚åˆéœ€è¦åŠ¨æ€è°ƒæ•´æƒé™çš„åœºæ™¯

### æ ¼å¼ 3ï¼šæ··åˆæ ¼å¼

```json
{
  "permissions": {
    "wechat": true,
    "ximalaya": {
      "enabled": true,
      "max_requests_per_day": 1000
    }
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒæƒé™é™„åŠ é…ç½®
- ç›®å‰ç³»ç»Ÿåªæ£€æŸ¥ç¬¬ä¸€å±‚çš„ bool å€¼
- é¢„ç•™æ‰©å±•ç©ºé—´

---

## ğŸ“ˆ ä¸šåŠ¡æµç¨‹

### å…¸å‹åº”ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šæ¡Œé¢åº”ç”¨å¯åŠ¨æ—¶

```
1. ç”¨æˆ·æ‰“å¼€åº”ç”¨
   â†“
2. åº”ç”¨è°ƒç”¨ç™»å½•æ¥å£
   â†“
3. è·å– token
   â†“
4. è°ƒç”¨ /permission/my-permissions
   â†“
5. æ ¹æ®è¿”å›çš„æƒé™åˆ—è¡¨ï¼Œå†³å®šæ˜¾ç¤ºå“ªäº›åŠŸèƒ½æ¨¡å—
   â†“
6. ç”¨æˆ·ç‚¹å‡»åŠŸèƒ½æ—¶ï¼Œå†æ¬¡è°ƒç”¨ /permission/check ç¡®è®¤
   â†“
7. ç¡®è®¤é€šè¿‡åï¼Œè°ƒç”¨ä¸šåŠ¡æ¥å£
```

#### åœºæ™¯ 2ï¼šWeb åº”ç”¨

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. å‰ç«¯è°ƒç”¨ /permission/my-permissions
   â†“
3. æ ¹æ®æƒé™åˆ—è¡¨æ¸²æŸ“èœå•
   â†“
4. ç”¨æˆ·è®¿é—®æŸä¸ªåŠŸèƒ½é¡µé¢æ—¶
   â†“
5. åç«¯æ¥å£ä½¿ç”¨ @require_permission è£…é¥°å™¨
   â†“
6. è‡ªåŠ¨éªŒè¯æƒé™ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
```

#### åœºæ™¯ 3ï¼šAPI é›†æˆ

```
1. ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡ API è°ƒç”¨
   â†“
2. æ¯ä¸ªè¯·æ±‚éƒ½æºå¸¦ token
   â†“
3. åç«¯æ¥å£è‡ªåŠ¨éªŒè¯æƒé™
   â†“
4. è¿”å›ä¸šåŠ¡æ•°æ®æˆ– 403 é”™è¯¯
```

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. çµæ´»çš„éªŒè¯æµç¨‹
- âœ… 9æ­¥å®Œæ•´éªŒè¯ï¼Œç¡®ä¿å®‰å…¨æ€§
- âœ… æ”¯æŒå¤šå¡å¯†åœºæ™¯ï¼ˆéå†æŸ¥æ‰¾æœ‰æ•ˆå¡å¯†ï¼‰
- âœ… è‡ªåŠ¨æ›´æ–°è®¾å¤‡æ´»è·ƒæ—¶é—´

### 2. å¤šç§ä½¿ç”¨æ–¹å¼
- âœ… ç›´æ¥è°ƒç”¨ API æ¥å£
- âœ… ä½¿ç”¨è£…é¥°å™¨
- âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥
- âœ… é¢„å®šä¹‰å¸¸ç”¨æƒé™

### 3. å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„å¤±è´¥åŸå› 
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… æ ‡å‡†çš„ HTTP çŠ¶æ€ç 

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… æ‰¹é‡æ£€æŸ¥æƒé™ï¼ˆå‡å°‘ç½‘ç»œè¯·æ±‚ï¼‰
- âœ… ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æƒé™
- âœ… æ™ºèƒ½çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆè”è¡¨æŸ¥è¯¢ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šé˜¶æ®µäº”

é˜¶æ®µå››å·²å…¨éƒ¨å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹**é˜¶æ®µäº”ï¼šç®¡ç†åå°åŠŸèƒ½**çš„å¼€å‘ï¼š

### é˜¶æ®µäº”ä»»åŠ¡æ¸…å•
- [ ] ä»»åŠ¡ 14ï¼šå®ç°å¡å¯†ç”Ÿæˆæ¥å£ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] ä»»åŠ¡ 15ï¼šå®ç°ç”¨æˆ·ç®¡ç†æ¥å£ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] ä»»åŠ¡ 16ï¼šå®ç°è®¾å¤‡ç®¡ç†æ¥å£ï¼ˆç®¡ç†å‘˜ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **device_id å¯é€‰**
   - å¦‚æœä¸æä¾›ï¼Œä½¿ç”¨ç™»å½•æ—¶çš„ device_id
   - å¦‚æœæä¾›ï¼Œä½¿ç”¨æŒ‡å®šçš„ device_id

2. **æƒé™é…ç½®æ ¼å¼**
   - æ”¯æŒ list å’Œ dict ä¸¤ç§æ ¼å¼
   - list æ ¼å¼æ›´ç®€å•ï¼Œæ¨èä½¿ç”¨
   - dict æ ¼å¼æ›´çµæ´»ï¼Œæ”¯æŒç»†ç²’åº¦æ§åˆ¶

3. **å¤šå¡å¯†æ”¯æŒ**
   - ç”¨æˆ·å¯ä»¥ç»‘å®šå¤šä¸ªå¡å¯†
   - æƒé™æ ¡éªŒä¼šéå†æ‰€æœ‰å¡å¯†
   - åªè¦æœ‰ä¸€ä¸ªå¡å¯†æ»¡è¶³æ¡ä»¶å³é€šè¿‡

4. **è®¾å¤‡æ´»è·ƒæ—¶é—´**
   - æ¯æ¬¡æƒé™éªŒè¯é€šè¿‡æ—¶è‡ªåŠ¨æ›´æ–°
   - å¯ç”¨äºç»Ÿè®¡è®¾å¤‡ä½¿ç”¨æƒ…å†µ
   - å¯ç”¨äºæ£€æµ‹å¼‚å¸¸è®¾å¤‡

---

## ğŸ“‹ å¾…å®ŒæˆåŠŸèƒ½

### å½“å‰é˜¶æ®µç¼ºå°‘çš„åŠŸèƒ½
- â³ æƒé™ä½¿ç”¨ç»Ÿè®¡
- â³ æƒé™å˜æ›´é€šçŸ¥
- â³ æƒé™è¿‡æœŸæé†’

è¿™äº›åŠŸèƒ½å°†åœ¨åç»­é˜¶æ®µæˆ–å¢å¼ºä¼˜åŒ–ä¸­å®ç°ã€‚

---

**é˜¶æ®µå››å®Œæˆï¼ğŸ‰**

ç³»ç»Ÿç°åœ¨å·²å…·å¤‡å®Œæ•´çš„æƒé™æ ¡éªŒåŠŸèƒ½ï¼š
- âœ… 9æ­¥ä¸¥æ ¼éªŒè¯æµç¨‹
- âœ… 3ä¸ªæƒé™æ ¡éªŒæ¥å£
- âœ… 2ç§ä½¿ç”¨æ–¹å¼ï¼ˆè£…é¥°å™¨ + ä¾èµ–æ³¨å…¥ï¼‰
- âœ… å®Œå–„çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†
- âœ… æ”¯æŒæ‰¹é‡æ ¡éªŒå’Œæƒé™æŸ¥è¯¢

**è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åœ°æ§åˆ¶ç”¨æˆ·çš„åŠŸèƒ½è®¿é—®æƒé™äº†ï¼**
