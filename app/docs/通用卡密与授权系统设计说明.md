# 通用卡密与授权系统设计说明

> 目标：
>
> * 一套 **可复用的卡密 / 授权平台**，支持多个桌面程序或应用
> * 支持：用户控制、卡密控制、设备控制、权限控制、封禁、实时改权限
> * 第一版：不过度复杂，但具备商业可用性

---

## 一、整体架构

```
┌────────────────────────┐
│   授权 / 卡密中心（服务端） │
│                        │
│ - 用户系统              │
│ - 应用管理              │
│ - 卡密管理              │
│ - 设备管理              │
│ - 权限校验              │
│ - 封禁 / 改权限          │
└─────────▲──────────────┘
          │ HTTPS
┌─────────┴──────────────┐
│   桌面程序 / 客户端     │
│  Python + Vue3 + EXE    │
└────────────────────────┘
```

客户端只负责：

* 登录 / 注册
* 展示 UI
* 每次功能前向服务端请求权限校验

**所有是否可用的最终判定，都在服务端。**

---

## 二、核心业务流程

### 1. 用户流程

1. 启动客户端
2. 登录 / 注册（用户名 + 密码）
3. 登录成功 → 查询是否已绑定卡密
4. 若无卡密 → 强制停留在【卡密绑定页】
5. 若有卡密 → 获取权限、过期时间、设备信息

### 2. 功能使用流程（强制）

```
点击功能
  ↓
检查是否登录
  ↓
检查是否绑定卡密
  ↓
向服务端校验权限
  ↓
允许 / 拒绝执行
```

---

## 三、数据库设计

### 1️⃣ 应用表（app）

```sql
app
- id
- app_key            -- 应用唯一标识（内置在客户端）
- app_name
- status             -- normal / disabled
- created_at
```

---

### 2️⃣ 用户表（user）

```sql
user
- id
- username
- password_hash
- status             -- normal / banned
- created_at
- last_login_at
```

> 封禁用户 = 所有应用不可用

---

### 3️⃣ 卡密表（card）

```sql
card
- id
- app_id                     -- 所属应用
- card_key                   -- 卡密字符串（唯一）
- status                     -- unused / used / disabled
- expire_time                -- 过期时间
- max_device_count           -- 最大可绑定设备数
- permissions                -- JSON 权限
- remark                     -- 套餐/备注
- created_at
```

#### permissions 示例

```json
{
  "wechat": true,
  "ximalaya": false
}
```

或：

```json
["wechat", "ximalaya"]
```

---

### 4️⃣ 用户-卡密绑定表（user_card）

```sql
user_card
- id
- user_id
- card_id
- bind_time
- status              -- active / unbind
```

> 支持：一个用户绑定多个卡密（后期扩展）

---

### 5️⃣ 卡密-设备绑定表（card_device）

```sql
card_device
- id
- card_id
- device_id
- device_name         -- 可选（PC 名称）
- bind_time
- last_active_at
- status              -- active / disabled
```

绑定时规则：

```
已绑定设备数 < max_device_count
```

---

### 6️⃣ 用户 Token 表（可选）

```sql
user_token
- id
- user_id
- app_id
- token
- device_id
- expire_time
```

> 用于：踢下线、强制失效、设备级登录控制

---

## 四、接口设计

### 1️⃣ 登录 / 注册

```http
POST /api/auth/register
POST /api/auth/login
```

登录成功返回：

```json
{
  "token": "jwt_token",
  "user_status": "normal"
}
```

---

### 2️⃣ 查询用户卡密状态

```http
GET /api/card/my
Authorization: Bearer token
```

返回：

```json
{
  "has_card": true,
  "cards": [
    {
      "card_key": "****-****",
      "expire_time": "2026-01-01",
      "permissions": ["wechat"],
      "bind_devices": 1,
      "max_device_count": 2
    }
  ]
}
```

---

### 3️⃣ 绑定卡密

```http
POST /api/card/bind
Authorization: Bearer token
{
  "card_key": "XXXX-XXXX",
  "device_id": "abc123",
  "device_name": "MyPC"
}
```

校验逻辑：

1. 卡密是否存在
2. 是否属于当前应用
3. 是否禁用 / 是否过期
4. 是否超过最大设备数

---

### 4️⃣ 功能权限校验（每个功能必调）

```http
POST /api/permission/check
Authorization: Bearer token
{
  "permission": "wechat",
  "device_id": "abc123"
}
```

---

## 五、卡密生成接口（补全）

> **仅限后台 / 管理员使用**

### 1️⃣ 接口定义

```http
POST /api/admin/card/generate
Authorization: Bearer admin_token
```

请求参数：

```json
{
  "app_id": 1,
  "count": 100,
  "expire_time": "2026-01-01",
  "max_device_count": 2,
  "permissions": ["wechat", "ximalaya"],
  "remark": "高级套餐"
}
```

返回：

```json
{
  "cards": [
    "ABCD-EFGH-IJKL",
    "MNOP-QRST-UVWX"
  ]
}
```

---

### 2️⃣ 卡密生成规则（推荐）

* 长度：16～20 位
* 分段：4-4-4-4
* 字符集：`A-Z + 2-9`（避免 0/O/1/I 混淆）
* 唯一索引，防止重复

示例：

```
X9KD-A7QM-LP2E-W8RZ
```

---

### 3️⃣ 卡密初始状态

```text
status = unused
bind_user = null
bind_device = 0
```

首次绑定后：

```text
status = used
```

---

## 六、客户端强制策略

必须遵守：

1. 未登录 → 不进入主界面
2. 未绑定卡密 → 所有功能跳转到卡密绑定页
3. 每个功能执行前 → 调用权限校验接口

即使被反编译，也无法绕过服务端。

---

## 七、系统可支持的商业能力

* 控制用户登录
* 封禁用户（立即生效）
* 封禁卡密
* 修改卡密权限（实时）
* 控制设备数量
* 多应用共用一套授权系统

---

## 八、版本演进建议

### 第一版（当前）

* 用户 / 卡密 / 权限 / 设备

### 后续可扩展

* 邮箱验证码
* 付费 / 续费
* 卡密叠加
* 订阅制授权
* 管理后台 UI

---

> 本设计目标：
> **一次设计，长期使用，不因多产品返工。**
